# ฺฉูพุงุฑฺูโุณุงุฒ ููโุงูพ ุจุง ุฑุจุงุช ู Backend

ุงู ุณูุฏ ุชูุถุญ ูโุฏูุฏ ููโุงูพ ฺฺฏููู ุจุงุฏ ุจุง ุฑุจุงุช ุชูฺฏุฑุงูุ API ู ุฏุชุงุจุณ ูุนู ูพุฑูฺู ฺฉูพุงุฑฺู ุดูุฏ.

---

## ฑ. ููุทู ูุฑูุฏ ุฏุฑ ุฑุจุงุช (Bot โ Mini App)

### ฑ.ฑ. ูุญู ููุงุณุจ ุจุฑุง ุฏฺฉูู ููโุงูพ

- ูุงู ฺฉูุฏ: `handlers/user/modules/navigation/main_menu.py`
- ฺฉูุงุณ: `MainMenuHandler`
- ูุชุฏ: `start`

ุฏุฑ ุงู ูุชุฏุ ฺฉุจูุฑุฏ ุงุตู ฺฉุงุฑุจุฑ ุณุงุฎุชู ูโุดูุฏุ ุจูุชุฑู ุฌุง ุจุฑุง ุงุถุงูู ฺฉุฑุฏู ุฏฺฉููโ ยซ๐ฑ ููโุงูพยป ูููโุฌุงุณุช.

### ฑ.ฒ. ุงุฏูโ ูพุงุฏูโุณุงุฒ (ููููู ููููู)

> ุชูุฌู: ุงู ููุท ููููู ูุณุชูุฏ ุงุณุช ู ูููุฒ ุฏุฑ ฺฉุฏ ูพุฑูฺู ุงุนูุงู ูุดุฏูุ ุงฺฏุฑ ุฎูุงุณุชุฏุ ูโุชูุงู ุขู ุฑุง ุฏููุงู ุฏุฑ ฺฉุฏ ูพุงุฏู ฺฉุฑุฏ.

ฑ. ุฏุฑ ุจุงูุง ูุงูุ import ูุงุฒู ุจุฑุง WebApp:

```python
from telegram import WebAppInfo, KeyboardButton
from config.config import MINIAPP_ENABLED, MINIAPP_URL
```

ฒ. ุฏุฑ `MainMenuHandler.start`ุ ุจุนุฏ ุงุฒ ุณุงุฎุช `keyboard` ุงุตู:

```python
if MINIAPP_ENABLED and MINIAPP_URL:
    miniapp_button = KeyboardButton(
        text=kb("menu.buttons.miniapp", lang),
        web_app=WebAppInfo(url=MINIAPP_URL)
    )
    keyboard.append([miniapp_button])
```

ณ. ุจูู ููุทู ุชุงุจุน ุจุฏูู ุชุบุฑ ุจุงู ูโูุงูุฏ.

> ุฏุฑ ุตูุฑุช ุชูุงู ูโุชูุงู ุจู ุฌุง Reply Keyboard ุงุฒ Inline Keyboard ููุฑุงู ุจุง `InlineKeyboardButton(web_app=WebAppInfo(...))` ุงุณุชูุงุฏู ฺฉุฑุฏ.

---

## ฒ. ุฌุฑุงู ุฏุงุฏู Mini App โ API โ DB

### ฒ.ฑ. ููุง ฺฉู

```mermaid
sequenceDiagram
    participant U as User
    participant TG as Telegram Client
    participant BOT as Bot Backend
    participant API as MiniApp API
    participant DB as PostgreSQL

    U->>TG: ุจุงุฒ ฺฉุฑุฏู ุฑุจุงุช / ฺฉูฺฉ ุฑู ุฏฺฉูู ููโุงูพ
    TG->>BOT: ุฏุฑุงูุช /start
    BOT->>TG: ุงุฑุณุงู ฺฉุจูุฑุฏ ุจุง ุฏฺฉูู ููโุงูพ
    U->>TG: ฺฉูฺฉ ุฑู ุฏฺฉูู ููโุงูพ
    TG->>API: ุจุงุฒ ฺฉุฑุฏู URL ููโุงูพ ุจุง initData
    API->>API: ุงุนุชุจุงุฑุณูุฌ initData
    API->>DB: ุฎูุงูุฏู/ููุดุชู ุฏุงุฏูโูุง (ุงุฒ ุทุฑู DatabaseAdapter)
    API-->>TG: ูพุงุณุฎ JSON ุจู WebApp
```

- ุฏุฑ ุจุณุงุฑ ุงุฒ ูุนูุงุฑโูุงุ BOT ู API ูโุชูุงููุฏ ุฏุฑ ฺฉ ูพุฑูุณู ุจุงุดูุฏุ ููู ุงู ุงุณุช ฺฉู:
  - ูุงู API ุงุฒ ููุงู `DatabaseAdapter` ู `AttachmentAnalytics` ุงุณุชูุงุฏู ฺฉูุฏ.

---

## ณ. ุงุชุตุงู API ุจู ุฒุฑุณุงุฎุช ูุนู

### ณ.ฑ. ุฏุณุชุฑุณ ุจู ุฏุชุงุจุณ

ุฏุฑ ูุงฺูู API (ูุซูุงู `miniapp_api.py`)ุ ุจุฑุง ุฏุณุชุฑุณ ุจู DB ุจุงุฏ ุงุฒ `DatabaseAdapter` ุงุณุชูุงุฏู ุดูุฏ:

```python
from core.database.database_adapter import get_database_adapter
from utils.attachment_analytics import AttachmentAnalytics

_db = get_database_adapter()
_analytics = AttachmentAnalytics(_db)
``

- ุชูุงู handlerูุง HTTP (ูุซูุงู ุฏุฑ FastAPI/Flask) ุงุฒ `_db` ู `_analytics` ุงุณุชูุงุฏู ูโฺฉููุฏ.
- ุจูโุงูโุชุฑุชุจุ ููุทู ุฏุงุฏู ู ุขูุงูุชฺฉุณ ุจุง ุฑุจุงุช ฺฉุณุงู ุฎูุงูุฏ ุจูุฏ.

### ณ.ฒ. ูููููโ ุงูุชุฒุงุน ฺฉ endpoint (ูุซุงู ููููู)

```python
@app.get("/miniapp/v1/attachments")
def get_attachments(category: str, weapon: str, mode: str = "br"):
    # 1. ุงุนุชุจุงุฑุณูุฌ ูพุงุฑุงูุชุฑูุง (category, mode)
    # 2. ูุฑุงุฎูุงู ูุชุฏูุง DB
    top_items = _db.get_top_attachments(category, weapon, mode)
    all_items = _db.get_all_attachments(category, weapon, mode)
    season_items = _db.get_season_top_attachments_for_weapon(category, weapon, mode)
    # 3. ูฺฏุงุดุช ุจู ุณุงุฎุชุงุฑ ุฎุฑูุฌ API (ูุทุงุจู API_SPEC.md)
    return {"ok": True, "result": {...}}
```

> ุงู ฺฉุฏ ููุท ุจุฑุง ุชูุถุญ ุฌุฑุงู ุฏุงุฏู ุงุณุช ู ุฏุฑ ุฑูพู ูุนู ูุฌูุฏ ูุฏุงุฑุฏ.

---

## ด. ููโุฑุงุณุชุง i18n ุจู ุฑุจุงุช ู ููโุงูพ

- ุฑุจุงุช ุงุฒ `locales/fa.json` ู `locales/en.json` ู ุชุงุจุนโูุง `t` ู `kb` ุจุฑุง ุชุฑุฌูู ุงุณุชูุงุฏู ูโฺฉูุฏ.
- ููโุงูพ ูโุชูุงูุฏ ฺฉ ุงุฒ ุฏู ุฑูฺฉุฑุฏ ุฑุง ุงุชุฎุงุฐ ฺฉูุฏ:

1. **ุชุฑุฌูู ุณูุช Frontend**
   - ุจุณุชูโ ุชุฑุฌูู (JSON) ุฑุง ุฏุฑ Frontend ูฺฏู ุฏุงุฑุฏ ู ููุท keyูุง ุฑุง ุงุฒ API ุจฺฏุฑุฏ.

2. **ุชุฑุฌูู ุณูุช Backend**
   - API ูุชู ุชุฑุฌููโุดุฏู ุฑุง ุจุฑฺฏุฑุฏุงูุฏ (ูุซูุงู ูุงู ุฏุณุชูโูุง/ููุฏูุง).

ูพุดููุงุฏ ุฏุฑ ุงู ูพุฑูฺู:

- ุจุฑุง ุฏุงุฏูโูุง ยซุฏุงููยป (ูุงููุฏ ูุงู ุณูุงุญ ู ุงุชฺููุช) ุงุฒ ููุงู ููุงุฏุฑ ุฏุชุงุจุณ ุงุณุชูุงุฏู ุดูุฏ (ุงุบูุจ ุงูฺฏูุณ).
- ุจุฑุง label ูุง UIุ Frontend ุชุฑุฌููโูุง ุฎูุฏุด ุฑุง ุฏุงุดุชู ุจุงุดุฏ ุชุง ุงุฒ ุชุบุฑุงุช ูุณุชูู ุจุงุดุฏ.

---

## ต. ููุงููฺฏ ุจุง ุญุงูุช Webhook

ุงฺฏุฑ ุจุฑุงุณุงุณ `docs/NEW_FEATURES_IMPLEMENTATION.md`ุ ุฑุจุงุช ุจู ุญุงูุช Webhook ููุงุฌุฑุช ฺฉูุฏ:

- ูโุชูุงู ุฑุจุงุช ู API ููโุงูพ ุฑุง ุฑู ฺฉ ูุจโุณุฑูุฑ ูุงุญุฏ ุงุฌุฑุง ฺฉุฑุฏ.
- ููููู ุทุฑุญ:
  - `https://your-domain.com/telegram/webhook` โ Webhook ุฑุจุงุช.
  - `https://your-domain.com/miniapp/v1/...` โ API ููโุงูพ.

ุงู ููโูฺฉุงู ุจุงุนุซ ุณุงุฏูโุชุฑ ุดุฏู ุชูุธูุงุช BotFather ู ุงููุช (ฺฉ ุฏุงูููโ ูุงุญุฏ) ูโุดูุฏ.

---

## ถ. ุชุณุช ู ูุงูุชูุฑูฺฏ ฺฉูพุงุฑฺู

- ุจุฑุง ุงุทููุงู ุงุฒ ุณูุงูุช ฺฉู ุฒูุฌุฑู:
  - E2E Tests ุทุจู `TESTING_VALIDATION.md` ุงุฌุฑุง ุดููุฏ.
  - ูุงฺฏโูุง ุฑุจุงุช ู API ุฏุฑ ฺฉ ุณุณุชู ูุฑฺฉุฒ ูฺฏูโุฏุงุฑ ุดููุฏ.

- ุฏุฑ ุตูุฑุช ุงุถุงูู ฺฉุฑุฏู ุงุจุฒุงุฑูุง ูุงููุฏ Sentry ุง Prometheus:
  - ุฎุทุงูุง ู ูุชุฑฺฉโูุง ููโุงูพ ูุฒ ุจุงุฏ ุฏุฑ ููุงู ุฏุงุดุจูุฑุฏูุง ููุงุด ุฏุงุฏู ุดููุฏ.

---

## ท. ุฌูุนโุจูุฏ

- ุฏฺฉููโ ููโุงูพ ุฏุฑ ููู ุงุตู ุฑุจุงุช ููุทูโ ูุฑูุฏ ฺฉุงุฑุจุฑ ุงุณุช.
- API ููโุงูพ ุจุงุฏ ุฑู ููุงู ุฒุฑุณุงุฎุช DB/Analytics ุฑุจุงุช ุณูุงุฑ ุดูุฏ.
- ุงู ุณูุฏ ุฎุทูุท ุงุตู ฺฉูพุงุฑฺูโุณุงุฒ ุฑุง ูุดุฎุต ูโฺฉูุฏุ ุฌุฒุฆุงุช ุฏููโุชุฑ ุฏุฑ `ARCHITECTURE.md`, `IMPLEMENTATION.md` ู `API_SPEC.md` ุขูุฏู ุงุณุช.
