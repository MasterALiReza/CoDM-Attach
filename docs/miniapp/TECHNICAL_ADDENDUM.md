# مستندات فنی تکمیلی مینی‌اپ تلگرام CODM Attachments

این سند جزئیات فنی تکمیلی، وابستگی‌ها، محدودیت‌های سیستم و پیشنهادهای توسعه آینده را برای مینی‌اپ تلگرام توضیح می‌دهد.

---

## ۱. وابستگی‌ها (Dependencies)

### ۱.۱. وابستگی‌های هسته (Backend)

بر اساس `requirements.txt` و کد فعلی پروژه:

- **Telegram Bot & Framework**
  - `python-telegram-bot==21.5` – هسته‌ی ربات.
  - `python-dotenv==1.0.0` – بارگذاری تنظیمات از `.env`.

- **پایگاه داده**
  - `psycopg[binary]==3.2.3` – درایور PostgreSQL.
  - `psycopg-pool==3.2.3` – connection pooling.

- **جستجو و پردازش متن**
  - `fuzzywuzzy==0.18.0`
  - `python-Levenshtein==0.25.0`
  - Postgres extensions: `pg_trgm`, `unaccent` (در `init_postgres.sql`).

- **زمان‌بندی و اتوماسیون**
  - `APScheduler==3.10.4`
  - `schedule==1.2.1`

- **بقیه ابزارها**
  - `feedparser`, `beautifulsoup4`, `lxml`, `requests` (برای بخش‌های دیگر ربات).

مینی‌اپ عمدتاً روی همین زیرساخت سوار می‌شود و وابستگی اضافی اجباری ندارد.

### ۱.۲. وابستگی‌های پیشنهادی برای API مینی‌اپ

(در حال حاضر در پروژه اضافه نشده‌اند، اما برای پیاده‌سازی واقعی پیشنهاد می‌شوند):

- **FastAPI** یا **Flask** برای پیاده‌سازی REST API.
- **Uvicorn** یا **Gunicorn** برای سرویس‌دهی HTTP.

نمونه‌ی پیشنهادی (غیر الزام‌آور):

```bash
pip install fastapi uvicorn
```

---

## ۲. محدودیت‌های فعلی سیستم

### ۲.۱. معماری اجرا

- ربات فعلی به‌صورت یک پروسه‌ی Python واحد اجرا می‌شود.
- در حالت polling، وابسته به latency شبکه تلگرام و سرور است.
- در وضعیت فعلی، API اختصاصی مینی‌اپ پیاده‌سازی نشده و فقط طراحی آن موجود است.

### ۲.۲. دیتابیس

- فقط **یک** دیتابیس PostgreSQL در نظر گرفته شده است.
- Sharding یا multi-tenant به‌صورت built-in وجود ندارد.
- برخی جداول (مانند `attachment_metrics`, `attachment_performance`) ممکن است با رشد داده نیاز به ایندکس‌ها و استراتژی‌های آرشیو داشته باشند.

### ۲.۳. آنالیتیکس

- ماژول `AttachmentAnalytics` بر اساس eventهای ثبت شده کار می‌کند.
- اگر رویدادهای مینی‌اپ (view/click/rate) به‌طور منظم ارسال نشوند، داده‌های آماری ناقص خواهد بود.

### ۲.۴. مقیاس‌پذیری (Scalability)

- برای load های خیلی بالا، نیاز به:
  - چندین instance از سرویس Python + Load Balancer.
  - صف‌های پیام (Message Queue) برای پردازش ناهمزمان رویدادهای آنالیتیکس.

این موارد در طراحی فعلی لحاظ نشده‌اند و باید در فازهای توسعه بعدی مدنظر قرار گیرند.

---

## ۳. نکات طراحی مهم (Design Decisions)

### ۳.۱. استفاده از DatabaseAdapter

- به جای اتصال مستقیم به psycopg، تمام دسترسی‌ها از طریق `DatabaseAdapter` انجام می‌شود.
- مزایا:
  - جداسازی لایه داده از لایه منطق.
  - امکان تغییر backend در آینده بدون تغییر API مینی‌اپ.

### ۳.۲. استفاده از AttachmentAnalytics

- منطق آماری (trending, underperforming, performance scores) در یک ماژول مجزا متمرکز شده است.
- API مینی‌اپ صرفاً مصرف‌کننده‌ی این متدها خواهد بود و نیاز به محاسبات دستی مجدد ندارد.

### ۳.۳. i18n و زبان‌ها

- زبان پیش‌فرض: `fa` (در `config.DEFAULT_LANG`).
- زبان‌های پشتیبانی شده: `fa,en` (در `config.SUPPORTED_LANGS`).
- مینی‌اپ باید:
  - زبان کاربر را از `initData` یا از جدول `users.language` (از طریق `DatabasePostgresProxy.get_user_language`) تشخیص دهد.
  - در صورت امکان، متن‌ها/label های UI را با همان زبان کاربر نمایش دهد.

---

## ۴. پیشنهادهای توسعه آینده

### ۴.۱. بهبود API مینی‌اپ

- اضافه کردن endpoint های تکمیلی:
  - پیشنهادات شخصی‌سازی‌شده بر اساس `user_attachment_engagement`.
  - endpoint برای «محبوب‌ترین‌ها» در بازه‌های زمانی متفاوت.

- افزودن نسخه‌بندی رسمی:
  - `/miniapp/v1/...` → نسخه فعلی.
  - فضای کافی برای `/miniapp/v2/...` در آینده.

### ۴.۲. بهبود آنالیتیکس

- ساخت داشبورد مدیریتی برای مشاهده:
  - ترندهای استفاده از اتچمنت‌ها.
  - نقاط ضعف (underperforming attachments).

- استفاده از ابزارهای خارجی:
  - Prometheus + Grafana برای جمع‌آوری و نمایش متریک‌ها (مطابق پیشنهاد در `IMPROVEMENTS_GUIDE.md`).

### ۴.۳. تجربه کاربری و UI

- ذخیره‌ی «آخرین انتخاب‌های کاربر» در جدول ساده (یا در `users`/`user_attachment_engagement`) و پیشنهاد آن‌ها در صفحه‌ی اول مینی‌اپ.
- اضافه کردن حالت آفلاین (caching در Frontend) برای بهبود سرعت perceived.

### ۴.۴. مقیاس‌پذیری و پایداری

- اجرای ربات و API در کانتینرهای جداگانه (Docker Compose / Kubernetes).
- استفاده از Load Balancer و Health Check برای اطمینان از uptime بالا.

---

## ۵. جمع‌بندی

- مینی‌اپ تلگرام بر روی زیرساخت قدرتمند فعلی (PostgreSQL + DatabaseAdapter + AttachmentAnalytics) سوار می‌شود.
- این سند نگاهی عمیق‌تر به وابستگی‌ها، محدودیت‌ها و مسیر توسعه‌ی آینده ارائه می‌کند.
- برای پیاده‌سازی عملی، باید این نکات در کنار اسناد `ARCHITECTURE.md`, `IMPLEMENTATION.md`, `API_SPEC.md` و `SECURITY.md` در نظر گرفته شوند.
