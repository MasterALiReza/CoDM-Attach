# ูพุงุฏูโุณุงุฒ ููโุงูพ ุชูฺฏุฑุงู CODM Attachments

ุงู ุณูุฏ ูุฑุงุญู ูพุงุฏูโุณุงุฒ ููโุงูพ ุฑุง ฺฏุงูโุจูโฺฏุงู ุชูุถุญ ูโุฏูุฏ ู ูุดุงู ูโุฏูุฏ ุฏููุงู ฺฉุฏุงู ุจุฎุดโูุง ฺฉุฏ ูุนู ุจุงุฏ ุงุณุชูุงุฏู ุง ุชูุณุนู ุฏุงุฏู ุดููุฏ.

> **ูุถุนุช ูุนู:** ููโุงูพ ูููุฒ ุฏุฑ ฺฉุฏ ูพุงุฏู ูุดุฏู ุงุณุชุ ุชููุง key ุชุฑุฌูู (`menu.buttons.miniapp`) ู ุฒุฑุณุงุฎุชโูุง ูุดุชุฑฺฉ (ุจุงุชุ ุฏุชุงุจุณุ ุขูุงูุชฺฉุณ) ูุฌูุฏ ุฏุงุฑูุฏ.

---

## ฑ. ูุงูโูุง ู ูุงฺููโูุง ูุฑุชุจุท ุฏุฑ ูุถุนุช ูุนู

### ฑ.ฑ. ูุฑูุฏ ู ุณุงุฎุช Application

- `main.py`
  - ุณุงุฎุช ุดุก ุฑุจุงุช (ูุซูุงู `CODMAttachmentsBot`).
  - ุงุฌุงุฏ `Application` ู ุงุฌุฑุง `run_polling`.

- `app/factory.py`
  - ฺฉูุงุณ `BotApplicationFactory`
    - `create_application()` โ ุณุงุฎุช Application ู ุชูุธู `bot_data`.
    - `setup_handlers()` โ ุซุจุช ููุฏูุฑูุง ุงุฒ ุทุฑู registry ูุง.

### ฑ.ฒ. ููู ุงุตู ู ููุทู ูุฑูุฏ ฺฉุงุฑุจุฑ

- `handlers/user/modules/navigation/main_menu.py`
  - ฺฉูุงุณ `MainMenuHandler` ู ูุชุฏ `start`:
    - ุณุงุฎุช ฺฉุจูุฑุฏ ุงุตู (`ReplyKeyboardMarkup`).
    - ุงุณุชูุงุฏู ุงุฒ `kb("menu.buttons.game_settings", lang)` ู ฺฉูุฏูุง ุฏฺฏุฑ.
  - ุงู ุชุงุจุน ุฌุง ุงุณุช ฺฉู ุฏฺฉูู ยซ๐ฑ ููโุงูพยป ุจุงุฏ ุจู ุขู ุงุถุงูู ุดูุฏ.

### ฑ.ณ. ุฏุชุงุจุณ ู ุงุชฺููุชโูุง

- `core/database/database_adapter.py`
  - ูุชุฏูุง ููู ุจุฑุง ููโุงูพ:
    - `get_weapons_in_category(category)`
    - `get_all_attachments(category, weapon_name, mode)`
    - `get_top_attachments(category, weapon_name, mode)`
    - `get_season_top_attachments(mode)`
    - `get_attachment_by_id(attachment_id)` (ุฏุฑ ูุณุฎู PostgreSQL)

- `core/database/database_pg_proxy.py`
  - ุดุงูู SQL ูุงูุน ุจุฑุง ุฎูุงูุฏู/ููุดุชู ุฑู ุฌุฏุงูู:
    - `weapons`, `attachments`, `user_attachment_engagement`, `attachment_performance` ู ...

### ฑ.ด. ุขูุงูุชฺฉุณ

- `utils/attachment_analytics.py`
  - ฺฉูุงุณ `AttachmentAnalytics` ุจุง ูุชุฏูุง ูุซู:
    - `track_view`, `track_click`, `track_share`, `track_copy`
    - `track_rating`
    - `get_attachment_stats`, `get_trending_attachments`, `get_underperforming_attachments`

ุงู ูุงฺูู ุจุฑุง ููโุงูพ ููุด ยซููุชูุฑ ุขูุงุฑยป ุฑุง ุจุงุฒ ูโฺฉูุฏ.

---

## ฒ. ฺฏุงูโูุง ุชูุณุนู ุณูุช ุจุงุช (Bot Side)

### ฒ.ฑ. ุชูุธูุงุช ุฌุฏุฏ ุฏุฑ `.env` ู `config`

ูพุดููุงุฏ ูโุดูุฏ ูุชุบุฑูุง ุฒุฑ ุงุถุงูู ุดููุฏ (ูุณุชูุฏุ ูู ูุฒููุงู ูพุงุฏูโุณุงุฒ ุดุฏู):

- ุฏุฑ `.env`:

```bash
MINIAPP_ENABLED=true
MINIAPP_URL=https://your-domain.com/miniapp
```

- ุฏุฑ `config/config.py` (ุทุฑุญ ูพุดููุงุฏ):

```python
MINIAPP_ENABLED = os.getenv("MINIAPP_ENABLED", "false").lower() == "true"
MINIAPP_URL = os.getenv("MINIAPP_URL")
```

ุงู ููุงุฏุฑ ุฏุฑ ููู ู ุฏุฑ ุชููุฏ ุฏฺฉูู Web App ุงุณุชูุงุฏู ูโุดููุฏ.

### ฒ.ฒ. ุงุถุงูู ฺฉุฑุฏู ุฏฺฉูู ยซููโุงูพยป ุจู ููู ุงุตู

- ููุทู ููุงุณุจ: `MainMenuHandler.start` ุฏุฑ `handlers/user/modules/navigation/main_menu.py`.
- ุฏุฑ ุญุงู ุญุงุถุฑ ฺฉุจูุฑุฏ ุชูุฑุจุงู ุจู ุดฺฉู ุฒุฑ ุณุงุฎุชู ูโุดูุฏ (ุฎูุงุตูโุดุฏู):

```python
keyboard = [
    [kb("menu.buttons.game_settings", lang), kb("menu.buttons.get", lang)],
    ...
]
```

- ุณูุงุฑู ูพุดููุงุฏ:
  - ุงฺฏุฑ `MINIAPP_ENABLED` ู `MINIAPP_URL` ุชูุธู ุดุฏู ุจุงุดูุฏุ ฺฉ ุฑุฏู ุฌุฏุฏ ุจุง ุฏฺฉูู ยซ๐ฑ ููโุงูพยป ุงุถุงูู ุดูุฏ.
  - ุงู ุฏฺฉูู ุจุฑุง ฺฉุงุฑุจุฑุงู ูุนููู ฺฉ Web App ุฑุง ุจุงุฒ ูโฺฉูุฏ (ุจุง ุงุณุชูุงุฏู ุงุฒ `WebAppInfo`).

> **ูฺฉุชู:** ุฏุฑ ฺฉุชุงุจุฎุงูู `python-telegram-bot`ุ ูโุชูุงู ุงุฒ `KeyboardButton(web_app=WebAppInfo(url=MINIAPP_URL))` ุง `InlineKeyboardButton(web_app=WebAppInfo(...))` ุงุณุชูุงุฏู ฺฉุฑุฏ. ุฏุฑ ฺฉุฏ ููุฌูุฏ ูููุฒ ฺูู ุฏฺฉููโุง ุณุงุฎุชู ูุดุฏู ู ุงู ุจุฎุด ุฏุฑ ุญุฏ ุทุฑุงุญ ุงุณุช.

### ฒ.ณ. ูุฏุฑุช session ููโุงูพ ู `initData`

- ููฺฏุงู ุจุงุฒ ุดุฏู WebAppุ ุชูฺฏุฑุงู `initData` ุฑุง ุจู frontend ูโูุฑุณุชุฏ.
- frontend ุจุงุฏ ุงู ุฏุงุฏู ุฑุง ุจู ุณุฑูุฑ (Bot Backend / API) ุจูุฑุณุชุฏ ุชุง **ููุช ฺฉุงุฑุจุฑ** ุชุฃุฏ ุดูุฏ.
- Backend ุจุงุฏ ูุทุงุจู ูุณุชูุฏ ุฑุณู ุชูฺฏุฑุงู:
  - ูพุงุฑุงูุชุฑูุง ุฑุง ุจู ุชุฑุชุจ ูุดุฎุต ูุฑุชุจ ฺฉูุฏ.
  - ุจุง ุงุณุชูุงุฏู ุงุฒ ุชูฺฉู ุฑุจุงุช (`BOT_TOKEN`) HMAC ุฑุง ูุญุงุณุจู ฺฉูุฏ.
  - ุงูุถุง ุฏุฑุงูุช ุฑุง ุจุง ููุฏุงุฑ ูุญุงุณุจูโุดุฏู ููุงุณู ฺฉูุฏ.

ุฌุฒุฆุงุช ุงู ุงูฺฏูุฑุชู ุฏุฑ `SECURITY.md` ุชูุถุญ ุฏุงุฏู ูโุดูุฏุ ุฏุฑ ุงู ุณูุฏ ููุท ูุณุฑ ูพุงุฏูโุณุงุฒ ุชูุตู ุดุฏู ุงุณุช.

### ฒ.ด. ุฑูุชโูุง API ุฏุงุฎู ุจฺฉโุงูุฏ

ุจุฑุง ุณุฑูุณโุฏู ุจู ููโุงูพ ูุงุฒ ุจู endpoint ูุง HTTP/JSON ุงุณุช (ูุซูุงู ุจุง FastAPI ุง Flask):

ููููู ุทุฑุงุญ (ุฏุฑ `API_SPEC.md` ููุตูโุชุฑ ูโุขุฏ):

- `GET /miniapp/v1/categories`
  - ุฎุฑูุฌ: ูุณุช ุฏุณุชูโูุง ุณูุงุญ.
- `GET /miniapp/v1/weapons?category=assault_rifle`
  - ุฎุฑูุฌ: ูุณุช ุณูุงุญโูุง ฺฉ ุฏุณุชู.
- `GET /miniapp/v1/attachments?category=...&weapon=...&mode=br`
  - ุฎุฑูุฌ: ูุณุช ุงุชฺููุชโูุง (top ู all).
- `GET /miniapp/v1/trending`
  - ุฎุฑูุฌ: ูุณุช ุชุฑูุฏูุง (`AttachmentAnalytics.get_trending_attachments`).

ุงู endpoint ูุง ูุณุชููุงู ุงุฒ ูุชุฏูุง `DatabaseAdapter` ู `AttachmentAnalytics` ุงุณุชูุงุฏู ูโฺฉููุฏ.

### ฒ.ต. ฺฏุฒุงุฑุด ุฑูุฏุงุฏูุง ฺฉุงุฑุจุฑ ุงุฒ ููโุงูพ

ูุฑ ุฒูุงู ฺฉู ฺฉุงุฑุจุฑ ุฏุฑ ููโุงูพ ฺฉุงุฑ ุงูุฌุงู ูโุฏูุฏ (ูุซูุงู ูุดุงูุฏู ุง ุงูุชุฎุงุจ ฺฉ ุงุชฺููุช)ุ frontend ูโุชูุงูุฏ API ุฒุฑ ุฑุง ุตุฏุง ุจุฒูุฏ:

- `POST /miniapp/v1/events`
  - ูุฑูุฏ: `{ attachment_id, event_type, user_id(optional), session_id(optional) }`
  - ุฏุฑ Back-End:
    - ุจุฑุงุณุงุณ `event_type` ุจู ฺฉ ุงุฒ ูุชุฏูุง `AttachmentAnalytics` ูฺฏุงุดุช ูโุดูุฏ:
      - `view` โ `track_view`
      - `click` โ `track_click`
      - `copy` โ `track_copy`
      - `share` โ `track_share`

ุงู ุฑูุฏุงุฏูุง ุจุงุนุซ ุบูโุชุฑ ุดุฏู ุฏุงุฏูโูุง ุขูุงุฑ ูโุดููุฏ ฺฉู ุจุนุฏูุง ุฏุฑ ุฎูุฏ ููโุงูพ ูู ููุงุด ุฏุงุฏู ูโุดููุฏ.

---

## ณ. ฺฏุงูโูุง ุชูุณุนู ุณูุช Frontend (Web App)

### ณ.ฑ. ุจุงุฑฺฏุฐุงุฑ ุงููู (Initial Load)

ุณูุงุฑู ูพุดููุงุฏ ุจุฑุง ุตูุญู ุงุตู ููโุงูพ:

1. ุฏุฑุงูุช `initData` ุงุฒ Telegram WebApp API ุฏุฑ JS.
2. ุงุฑุณุงู `initData` ุจู API ุจฺฉโุงูุฏ ุจุฑุง ุงุนุชุจุงุฑุณูุฌ ู ุฏุฑุงูุช ฺฉ ุชูฺฉู session (ูุซูุงู JWT ุณุจฺฉ ุง session id ุณุงุฏู).
3. ุฏุฑุงูุช ุชูุธูุงุช ุงููู ุงุฒ ุจฺฉโุงูุฏ:
   - ูุณุช ุฏุณุชูโูุง (`/miniapp/v1/categories`).
   - ูุณุช ุณูุงุญโูุง ูพุดโูุฑุถ ุง ุขุฎุฑู ุงูุชุฎุงุจ ฺฉุงุฑุจุฑ.
   - ฺูุฏ ุงุชฺููุช ุจุฑุชุฑ ู ฺูุฏ ููุฑุฏ ุชุฑูุฏ.

### ณ.ฒ. ูุงูุจุฑ ุจู ุตูุญุงุช

- **ุงูุชุฎุงุจ ุฏุณุชู** โ ูุฑุงุฎูุงู `/miniapp/v1/weapons`.
- **ุงูุชุฎุงุจ ุณูุงุญ** โ ูุฑุงุฎูุงู `/miniapp/v1/attachments`.
- **ุงูุชุฎุงุจ ููุฏ (BR/MP)** โ ูพุงุฑุงูุชุฑ `mode` ุฏุฑ ููุงู endpoint.

ูุฑ ุชุบุฑ view ุจุงุฏ ููุฑุงู ุจุง ฺฉ ุฑูุฏุงุฏ `view` ุจุฑุง ุงุชฺููุชโูุง ููุงุดโุฏุงุฏูโุดุฏู ุซุจุช ุดูุฏ (ุง ุญุฏุงูู ุจุฑุง ููุงุฑุฏ ฺฉู ฺฉุงุฑุจุฑ ุฑู ุขูโูุง ฺฉูฺฉ ูโฺฉูุฏ).

### ณ.ณ. ููุงุด ุฏุงุฏูโูุง ุชุญูู

- ุฏุฑ ุตูุญุงุช ยซุจุฑุชุฑูโูุงยป ู ยซุชุฑูุฏูุงยป ูโุชูุงู:
  - ุงุฒ `/miniapp/v1/trending` ุจุฑุง ููุงุด ฺฉุงุฑุชโูุง ุชุฑูุฏ ุงุณุชูุงุฏู ฺฉุฑุฏ.
  - ุงุฒ ุฏุงุฏูโูุง ุขูุงุฑ ุฏุฑ ูพุงุณุฎ ุงุชฺููุช (views/clicks/rating/popularity) ุจุฑุง ููุงุด ููุงุฑูุง ูพุดุฑูุช ุง badge ุงุณุชูุงุฏู ฺฉุฑุฏ.

---

## ด. ฺุงูุดโูุง ูู ู ุฑุงูฺฉุงุฑูุง ูพุดููุงุฏ

### ด.ฑ. ููฺฏุงูโุณุงุฒ ุจู ุจุงุช ู ููโุงูพ

- **ฺุงูุด:** ฺฉุงุฑุจุฑ ููฺฉู ุงุณุช ูู ุงุฒ ุทุฑู ฺุช ูุชู ู ูู ุงุฒ ุทุฑู ููโุงูพ ุจุง ุณุณุชู ฺฉุงุฑ ฺฉูุฏ.
- **ุฑุงูฺฉุงุฑ:**
  - ุชูุงู ุฏุงุฏูโูุง ุฏุฑ ฺฉ ุฏุชุงุจุณ ูุดุชุฑฺฉ ุฐุฎุฑู ูโุดููุฏ.
  - ุฑูุฏุงุฏูุง ููโุงูพ ู ุฑุจุงุช ูุฑ ุฏู ุฑู ุฌุฏุงูู ูุดุชุฑฺฉ (`attachment_metrics`, `user_attachment_engagement`) ุซุจุช ูโุดููุฏ.
  - ูุฑ ุฏู ุงู ฺฉุงูุงูโูุง ุฏุฑ ููุงุช ุจู ฺฉ ููุจุน ุญููุช ูุงุญุฏ (single source of truth) ุฎุชู ูโุดููุฏ.

### ด.ฒ. ุนููฺฉุฑุฏ (Performance)

- ุฎูุงูุฏู ุงุตู ุฏุงุฏูโูุง:
  - ุงุณุชูุงุฏู ุงุฒ ุงูุฏฺฉุณโูุง ููุฌูุฏ ุฑู `attachments` ู `weapons`.
  - ุงุณุชูุงุฏู ุงุฒ ูุชุฏูุง ุชุฌูุน ููุฌูุฏ ุฏุฑ `DatabasePostgresProxy`.
- ุชูุตูโูุง:
  - ฺฉุด ูุชุงุฌ ูพุฑูุตุฑู (ูุซูุงู ูุณุช ุฏุณุชูโูุง ู ุชุฑูุฏูุง) ุฏุฑ ูุงู API.
  - ุฏุฑ ุตูุฑุช ูุงุฒ ุงุณุชูุงุฏู ุงุฒ `core/cache` ููุฌูุฏ ุจุฑุง API ูุฒ.

### ด.ณ. ุงููุช ู ุณูุกุงุณุชูุงุฏู

- ุงุนุชุจุงุฑุณูุฌ ุชูุงู ุฏุฑุฎูุงุณุชโูุง API ุจุฑ ุงุณุงุณ `initData` ู ุดูุงุณู ฺฉุงุฑุจุฑ.
- Limit ฺฉุฑุฏู `event_type` ูุง ุจู ฺูุฏ ููุฏุงุฑ ูุฌุงุฒ.
- ุงุณุชูุงุฏู ุงุฒ rate limiting ุฑู endpoint ูุง ุฑูุฏุงุฏ (ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงุณูพู).

ุฌุฒุฆุงุช ุงููุช ุฏุฑ `SECURITY.md` ุชุดุฑุญ ูโุดูุฏ.

---

## ต. ุฎูุงุตู ูุณุฑ ุชูุณุนู

1. **ุงุถุงูู ฺฉุฑุฏู ุชูุธูุงุช ููโุงูพ** ุฏุฑ `.env` ู `config`.
2. **ุงูุฒูุฏู ุฏฺฉูู Mini App** ุจู `MainMenuHandler.start` (ReplyKeyboard ุง Inline Keyboard ุจุง `WebAppInfo`).
3. **ุงุฌุงุฏ API HTTP/JSON** (ุฏุฑ ูุงฺูู ูุซู `miniapp_api.py`) ฺฉู ุฑู `DatabaseAdapter` ู `AttachmentAnalytics` ุณูุงุฑ ุดูุฏ.
4. **ุณุงุฎุช Frontend Web App** ฺฉู ุงุฒ API ุงุณุชูุงุฏู ฺฉูุฏ ู ุจุง `initData` ฺฉุงุฑุจุฑ ุฑุง ุงุญุฑุงุฒ ููุช ฺฉูุฏ.
5. **ุงุชุตุงู ุฑูุฏุงุฏูุง UI** ุจู endpoint ุฑูุฏุงุฏ (`/miniapp/v1/events`) ุจุฑุง ุซุจุช view/click/rating.
6. **ุงุณุชูุฑุงุฑ ููุง** ูุทุงุจู ุฑุงูููุง `DEPLOYMENT_GUIDE.md` ู ุชุณุช ฺฉุงูู ุทุจู `TESTING_VALIDATION.md`.

ุจุง ุงูุฌุงู ุงู ูุฑุงุญูุ ููโุงูพ ุชูฺฏุฑุงู ุจูโุตูุฑุช ฺฉุงูู ู ููโุฑุงุณุชุง ุจุง ูุนูุงุฑ ูุนู ูพุฑูฺู ูพุงุฏูโุณุงุฒ ุฎูุงูุฏ ุดุฏ.
