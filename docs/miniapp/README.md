# مینی‌اپ تلگرام CODM Attachments

این پوشه شامل مستندات جامع برای طراحی و پیاده‌سازی «مینی‌اپ تلگرام» روی زیرساخت فعلی ربات CODM Attachments است.

> **نکته مهم:** در وضعیت فعلی کد، مینی‌اپ به‌صورت کامل پیاده‌سازی نشده است؛ تنها زیرساخت‌های اصلی (بات، دیتابیس، آنالیتیکس و i18n) آماده هستند. این مستندات، طراحی دقیق و گام‌به‌گام پیاده‌سازی را بر اساس معماری موجود توضیح می‌دهند.

---

## ۱. هدف مینی‌اپ

- **ارائه تجربه تعاملی‌تر** برای انتخاب سلاح و اتچمنت‌ها در قالب یک Web App داخل تلگرام.
- **استفاده مجدد از دیتابیس و منطق فعلی** ربات (PostgreSQL، DatabaseAdapter، AttachmentAnalytics).
- **نمایش داده‌های تحلیلی** مثل برترین اتچمنت‌ها، ترندها و پیشنهادها به‌صورت UI گرافیکی.
- **آماده‌سازی برای آینده** (Webhook Mode، داشبوردهای پیشرفته، شخصی‌سازی برای هر کاربر).

---

## ۲. وضعیت فعلی پیاده‌سازی در پروژه

در ریپو فعلی موارد زیر وجود دارند و برای مینی‌اپ استفاده می‌شوند:

- **بات تلگرام (python-telegram-bot 21.5)**
  - نقطه ورود: `main.py`
  - ساخت Application: `app.factory.BotApplicationFactory`
  - هندلرهای کاربر: `handlers/user/modules/*` (به‌ویژه `navigation/main_menu.py` و ماژول‌های attachments)
- **دیتابیس PostgreSQL**
  - اسکریپت ساخت جداول: `scripts/init_postgres.sql`
  - جداول کلیدی برای مینی‌اپ:
    - `weapon_categories`, `weapons`, `attachments`
    - `user_attachment_engagement`, `attachment_metrics`, `attachment_performance`
- **لایه دسترسی به دیتابیس**
  - کلاس مرکزی: `core/database/database_adapter.DatabaseAdapter`
  - پیاده‌سازی PostgreSQL: `core/database/database_pg_proxy.DatabasePostgresProxy`
- **آنالیتیکس اتچمنت‌ها**
  - ماژول: `utils/attachment_analytics.AttachmentAnalytics`
  - متدهایی مثل `track_view`, `track_click`, `track_rating`, `get_attachment_stats`, `get_trending_attachments`
- **i18n و منوها**
  - ترجمه‌ها: `locales/fa.json`, `locales/en.json`
  - کلید `menu.buttons.miniapp` در هر دو زبان تعریف شده است.
  - منوی اصلی کاربر: `handlers/user/modules/navigation/main_menu.py`

در حال حاضر هنوز:

- دکمه «مینی‌اپ» در کیبورد به‌طور واقعی استفاده نمی‌شود.
- هیچ handler ای برای دریافت `WebAppData` یا مدیریت session مینی‌اپ وجود ندارد.
- هیچ API اختصاصی HTTP/JSON برای مینی‌اپ پیاده‌سازی نشده است.

این مستندات دقیقاً توضیح می‌دهند که **چطور** این قسمت‌ها باید روی ساختار موجود سوار شوند.

---

## ۳. ساختار مستندات

این پوشه به چند فایل مجزا تقسیم شده تا خواندن و نگه‌داری آن ساده‌تر باشد:

- **`ARCHITECTURE.md`**
  - تحلیل معماری سیستم،
  - لایه‌های اصلی (Bot, Database, Analytics, Mini App Frontend)،
  - فلوچارت‌ها و نمودارهای Mermaid.

- **`IMPLEMENTATION.md`**
  - توضیح گام‌به‌گام توسعه مینی‌اپ،
  - نقاط اتصال در کد (handlers, factories, adapters)،
  - نمونه‌های شبه‌کد (pseudo-code) برای WebApp integration.

- **`DEPLOYMENT_GUIDE.md`**
  - پیش‌نیازهای محیط اجرا (Python, PostgreSQL, متغیرهای محیطی)،
  - مراحل نصب و راه‌اندازی بات،
  - توصیه برای استفاده از Webhook Mode همراه با مینی‌اپ،
  - نحوه استقرار frontend مینی‌اپ.

- **`TESTING_VALIDATION.md`**
  - سناریوهای تست UI و API،
  - تست‌های مرتبط با بات و مینی‌اپ به‌صورت end-to-end،
  - معیارهای عملکردی و پایداری.

- **`TECHNICAL_ADDENDUM.md`**
  - وابستگی‌ها و کتابخانه‌ها،
  - محدودیت‌های فعلی،
  - پیشنهادهای توسعه آینده.

فایل‌های تکمیلی (در مراحل بعدی تکمیل می‌شوند):

- **`API_SPEC.md`** – طراحی APIهای HTTP/JSON برای مینی‌اپ.
- **`SECURITY.md`** – نکات امنیتی، اعتبارسنجی `initData` تلگرام، rate limiting و غیره.
- **`INTEGRATION.md`** – نحوه یکپارچه‌سازی بین بات، API و frontend مینی‌اپ.
- **`CHECKLIST.md`** – چک‌لیست اجرایی پیاده‌سازی و استقرار.

---

## ۴. ترتیب پیشنهادی مطالعه

برای استفاده حداکثری از این مستندات:

1. **اول**: `ARCHITECTURE.md` – تصویر بزرگ سیستم و نحوه قرار گرفتن مینی‌اپ در کنار بات.
2. **سپس**: `IMPLEMENTATION.md` – گام‌های توسعه و نقاط اتصال در کد.
3. **بعد**: `DEPLOYMENT_GUIDE.md` – نحوه استقرار روی سرور واقعی.
4. **در ادامه**: `TESTING_VALIDATION.md` – اطمینان از درست کار کردن همه بخش‌ها.
5. **در نهایت**: `TECHNICAL_ADDENDUM.md` و فایل‌های تکمیلی برای جزئیات تخصصی.

---

## ۵. محدوده این مستندات (Scope)

چیزهایی که **پوشش داده می‌شوند**:

- طراحی و معماری مینی‌اپ روی زیرساخت فعلی.
- نحوه استفاده از دیتابیس و آنالیتیکس موجود برای سرویس‌دهی به مینی‌اپ.
- سناریوهای اصلی استفاده (مرور سلاح‌ها، اتچمنت‌ها، برترین‌ها، ترندها، پیشنهادها).
- الزامات استقرار روی سرور واقعی (HTTPS، دامنه، Webhook Mode، تنظیمات BotFather).

چیزهایی که **پوشش داده نمی‌شوند** (فقط به آن‌ها اشاره می‌شود):

- پیاده‌سازی کامل UI سمت frontend (React/Vanilla JS) – تنها الگو و ساختار کلی توضیح داده می‌شود.
- جزئیات کامل کدهای HMAC-Validation برای `initData` تلگرام – در `SECURITY.md` فقط الگوریتم و رفرنس‌ها توضیح داده می‌شود.

---

## ۶. وضعیت پیشرفت

- تحلیل معماری و زیرساخت فعلی پروژه انجام شده است.
- نقاط اتصال مینی‌اپ در کد (handlers، دیتابیس، آنالیتیکس) شناسایی شده‌اند.
- این پوشه، منبع واحد (Single Source of Truth) برای طراحی مینی‌اپ محسوب می‌شود؛ هر تغییری در طراحی باید ابتدا اینجا اعمال شود و سپس در کد پیاده‌سازی شود.
