# امنیت مینی‌اپ تلگرام CODM Attachments

این سند جنبه‌های امنیتی مینی‌اپ، به‌خصوص اعتبارسنجی `initData` تلگرام، محافظت از APIها و مدیریت نرخ درخواست‌ها را توضیح می‌دهد.

---

## ۱. مدل تهدید (Threat Model)

سناریوهای اصلی که باید در نظر گرفته شوند:

- **جعل هویت کاربر**
  - مهاجم تلاش کند با ارسال درخواست‌های مستقیم به API، خود را به‌عنوان کاربر دیگری معرفی کند.

- **دستکاری داده‌ها در سمت کلاینت**
  - تغییر `user.id`، `query_id` یا سایر فیلدها در `initData` یا payload.

- **مصرف منابع / DoS سبک**
  - ارسال volume بالای درخواست به endpoint های جستجو یا رویدادها.

- **نشت اطلاعات حساس**
  - نمایش پیام‌های خطای شامل stack trace یا اطلاعات داخلی دیتابیس.

هدف این سند، مشخص کردن مکانیزم‌های دفاعی در برابر این تهدیدها است.

---

## ۲. اعتبارسنجی `initData` تلگرام

تلگرام هنگام باز شدن WebApp، رشته‌ای به نام `initData` را در اختیار می‌گذارد. این داده باید در Backend اعتبارسنجی شود تا مطمئن شویم:

- از سمت تلگرام آمده است.
- مربوط به همین Bot (توکن فعلی) است.
- در مسیر انتقال دستکاری نشده است.

### ۲.۱. الگوریتم رسمی (خلاصه)

براساس مستند رسمی Telegram Web Apps:

1. رشته‌ی خام `initData` را از Frontend دریافت کنید (همان چیزی که از `Telegram.WebApp.initData` می‌آید).
2. آن را به پارامترهای جداگانه تقسیم کنید (مانند query string)، سپس:
   - پارامتر `hash` را جدا کنید.
   - روی باقی پارامترها، **data_check_string** بسازید:
     - کلیدها را به ترتیب حروف الفبا مرتب کنید.
     - هر ورودی را به صورت `key=value` بسازید.
     - این رشته‌ها را با `\n` به هم وصل کنید.
3. `secret_key` را بسازید:
   - `secret_key = HMAC_SHA256("WebAppData", bot_token)`
4. مقدار `check_hash` را محاسبه کنید:
   - `check_hash = HMAC_SHA256(secret_key, data_check_string)`
5. مقدار `hash` دریافتی از `initData` (hex) را با `check_hash` مقایسه کنید.
   - اگر برابر نبودند → داده نامعتبر است.

> **نکته امنیتی:** مقایسه را با تابعی انجام دهید که در برابر timing attack حساس نیست (مثلاً `hmac.compare_digest`).

### ۲.۲. نکات پیاده‌سازی

- هرگز `BOT_TOKEN` را در Frontend ارسال یا log نکنید.
- `initData` را به همان شکل خامی که تلگرام داده، از Frontend به Backend بفرستید.
- طول عمر پذیرفته شدن `initData` را محدود کنید (مثلاً اگر timestamp در داخل داده وجود دارد، بیش از چند دقیقه معتبر نباشد).

---

## ۳. مدیریت Session و Authorization

### ۳.۱. Session Token

پس از اعتبارسنجی موفق `initData`:

- یک `session_token` کوتاه‌عمر (مثلاً JWT یا توکن تصادفی ذخیره‌شده در Redis/DB) تولید کنید.
- اطلاعات زیر را در session نگه دارید:
  - `user_id`
  - `language`
  - زمان ایجاد و زمان انقضا

تمام endpoint های حساس (مثل `/attachments`, `/events`) باید یکی از موارد زیر را داشته باشند:

- هدر `Authorization: Bearer <session_token>`
- یا در حالت ساده‌تر، ارسال مجدد `initData` (کمتر توصیه می‌شود به‌خاطر حجم و پیچیدگی).

### ۳.۲. سطح دسترسی‌ها

- فعلاً تمام endpoint های مینی‌اپ در سطح «کاربر عادی» هستند؛ لازم نیست RBAC پیچیده اعمال شود.
- در آینده، برای endpoint های مدیریتی، می‌توان از سیستم role/permission موجود (جداول `roles`, `admins`, `admin_roles`) استفاده کرد.

---

## ۴. محافظت از API (Rate Limiting & Validation)

### ۴.۱. Rate Limiting

پیشنهاد می‌شود روی endpoint های زیر محدودیت نرخ اعمال شود:

- `/miniapp/v1/search` – برای جلوگیری از abuse جستجو.
- `/miniapp/v1/events` – برای جلوگیری از ارسال سیل رویداد.

نمونه سیاست:

- حداکثر ۱۰ درخواست در ثانیه برای هر `user_id` به `/events`.
- حداکثر ۵ درخواست در ثانیه برای هر `user_id` به `/search`.

روش پیاده‌سازی (نمونه‌ها):

- ذخیره‌ی شمارش درخواست‌ها در Redis یا جدول ساده.
- استفاده از الگوریتم Token Bucket یا Sliding Window.

### ۴.۲. اعتبارسنجی پارامترها

برای هر endpoint:

- `category` باید در لیست دسته‌های مجاز (`WEAPON_CATEGORIES` یا جدول `weapon_categories`) وجود داشته باشد.
- `mode` فقط یکی از `br` یا `mp` باشد.
- `attachment_id` حتماً باید در جدول `attachments` موجود باشد؛ در غیر این صورت، `404`.
- طول رشته‌های جستجو (`q`) محدود شود (مثلاً حداکثر ۵۰ کاراکتر).

---

## ۵. امنیت داده‌ها و حریم خصوصی

### ۵.۱. اطلاعات ذخیره‌شده

- جداولی مثل `users`, `attachment_metrics`, `user_attachment_engagement` شامل:
  - شناسه تلگرام (`user_id`)
  - نام کاربری، نام، زبان
  - آمار استفاده (views/clicks/rating)

توصیه‌ها:

- فقط داده‌هایی را ذخیره کنید که برای عملکرد سیستم لازم است.
- در گزارش‌ها و لاگ‌ها، از نمایش کامل آیدی/نام‌کاربری بدون ضرورت پرهیز کنید.

### ۵.۲. Logging

- در صورت بروز خطا، از `utils.logger` استفاده کنید.
- مراقب باشید در لاگ:
  - `BOT_TOKEN`, `DATABASE_URL`, `session_token` و `initData` کامل چاپ نشوند.

---

## ۶. امنیت Frontend مینی‌اپ

- Frontend نباید هیچ secret یا credentialی را در خود hard-code کند.
- تمام داده‌های حساس (مانند `user_id`) باید صرفاً از `initData` معتبر یا پاسخ سرور گرفته شوند.
- درخواست‌ها حتماً باید با HTTPS انجام شوند.

---

## ۷. به‌روزرسانی و ممیزی امنیتی

- در صورت تغییر در اسکیمای دیتابیس، لایه API یا منطق آنالیتیکس، این سند باید بازبینی شود.
- توصیه:
  - اجرای دوره‌ای ابزارهایی مانند `safety` برای بررسی وابستگی‌ها (مطابق `IMPROVEMENTS_GUIDE.md`).
  - اضافه کردن تست‌های امنیتی خودکار (یا حداقل اسکریپت‌های smoke-test) برای endpoint های حساس.

این سند چارچوب الزامات امنیتی مینی‌اپ را مشخص می‌کند؛ پیاده‌سازی واقعی باید مطابق این اصول انجام شود و در صورت نیاز با مشاوره امنیتی تکمیل گردد.
