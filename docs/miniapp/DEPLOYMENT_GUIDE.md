# ุฑุงูููุง ุงุณุชูุฑุงุฑ ููโุงูพ ุชูฺฏุฑุงู CODM Attachments

ุงู ุณูุฏ ูุฑุงุญู ุงุณุชูุฑุงุฑ ุฑุจุงุช + ููโุงูพ ุฑุง ุงุฒ ุฏุฏ ุนูู ุชูุถุญ ูโุฏูุฏุ ุจูโฺฏูููโุง ฺฉู ุจุง ูุนูุงุฑ ูุนู ูพุฑูฺู ุณุงุฒฺฏุงุฑ ุจุงุดุฏ.

---

## ฑ. ูพุดโูุงุฒูุง ูุญุท ุงุฌุฑุง

### ฑ.ฑ. ูุฑูโุงูุฒุงุฑูุง ู ุณุฑูุณโูุง

- **Python**
  - ูุณุฎู ุชูุตูโุดุฏู: 3.10 ุง ุจุงูุงุชุฑ (ูุทุงุจู ูพุฑูฺู ุงุตู).
- **PostgreSQL**
  - ูุณุฎู ุชูุตูโุดุฏู: 14 ุง ุจุงูุงุชุฑ.
- **ฺฉุชุงุจุฎุงููโูุง ูพุงุชูู**
  - ุทุจู `requirements.txt` ูพุฑูฺูุ ุงุฒ ุฌููู:
    - `python-telegram-bot==21.5`
    - `psycopg[binary]==3.2.3`
    - `APScheduler`, `schedule`, `feedparser`, `beautifulsoup4`, `lxml` ู ...
- **ฺฉ ุฏุงููู ุจุง HTTPS ูุนุชุจุฑ**
  - ุจุฑุง ุจุงุฒ ุดุฏู Mini App ุฏุฑ ุชูฺฏุฑุงูุ URL ุจุงุฏ ุญุชูุงู HTTPS ุฏุงุดุชู ุจุงุดุฏ.
  - ูุซุงู: `https://your-domain.com/miniapp`.

### ฑ.ฒ. ูุชุบุฑูุง ูุญุท ฺฉูุฏ

ุฏุฑ ฺฉูุงุฑ ูุชุบุฑูุง ูุนู ูพุฑูฺู (ูุซู `BOT_TOKEN`, `DATABASE_URL`, `SUPER_ADMIN_ID`)ุ ุจุฑุง ููโุงูพ ูพุดููุงุฏ ูโุดูุฏ:

```bash
MINIAPP_ENABLED=true
MINIAPP_URL=https://your-domain.com/miniapp
USE_WEBHOOK=true               # ุชูุตู ุจุฑุง ูุญุท production
WEBHOOK_URL=https://your-domain.com
WEBHOOK_PORT=8443
WEBHOOK_PATH=/telegram/webhook
SSL_CERT_PATH=/path/to/cert.pem
SSL_KEY_PATH=/path/to/privkey.pem
```

> **ูฺฉุชู:** ูพุงุฑุงูุชุฑูุง Webhook ุจุฑ ุงุณุงุณ ูพุดููุงุฏ ููุฌูุฏ ุฏุฑ `docs/NEW_FEATURES_IMPLEMENTATION.md` ุงุณุชุ ุงู ุณูุฏ ููุท ุขู ุฑุง ุฏุฑ ุฒููู ููโุงูพ ุชูุถุญ ูโุฏูุฏ.

---

## ฒ. ุขูุงุฏูโุณุงุฒ ุฏุชุงุจุณ

1. ูุตุจ PostgreSQL ู ุณุงุฎุช ุฏุชุงุจุณ:

```bash
createdb codm_bot
```

2. ุงุฌุฑุง ุงุณฺฉุฑูพุช ุงููู:

```bash
psql -d codm_bot -f scripts/init_postgres.sql
```

3. ุชูุธู `DATABASE_URL` ุฏุฑ `.env`ุ ููููู:

```bash
DATABASE_URL=postgresql+psycopg://user:password@localhost:5432/codm_bot
```

ุงู ฺฉุงุฑ ุฌุฏุงูู ููุฑุฏูุงุฒ ุจุฑุง ุณูุงุญโูุงุ ุงุชฺููุชโูุงุ ุขูุงูุชฺฉุณ ู UA ุฑุง ุงุฌุงุฏ ูโฺฉูุฏ.

---

## ณ. ุงุณุชูุฑุงุฑ Backend (ุฑุจุงุช + API ููโุงูพ)

### ณ.ฑ. ุญุงูุช ุชูุณุนู (Development)

- ุณุงุฏูโุชุฑู ุญุงูุช: ุงุฌุฑุง ุฑุจุงุช ุจูโุตูุฑุช polling ุฑู ููฺฉุงู:

```bash
pip install -r requirements.txt
python main.py
```

- ุฏุฑ ุงู ุญุงูุช:
  - ุฑุจุงุช ุฑู polling ฺฉุงุฑ ูโฺฉูุฏ.
  - Mini App URL ูโุชูุงูุฏ ุฑู `localhost` ูู ุชุณุช ุดูุฏุ ุงูุง ุฏุฑ ุชูฺฏุฑุงู ูุงูุน ุจุงุฒ ูุฎูุงูุฏ ุดุฏ (ุจูโุฎุงุทุฑ ูุงุฒ ุจู HTTPS). ุจุฑุง ุชุณุช UI ูโุชูุงูุฏ Web App ุฑุง ุฏุฑ ูุฑูุฑฺฏุฑ ูุนููู ุจุงุฒ ฺฉูุฏ.

### ณ.ฒ. ุญุงูุช Production ุจุง Webhook

ุจุฑุง ููโุงูพ ุฏุฑ ูุญุท ูุงูุนุ ุงุณุชูุงุฏู ุงุฒ Webhook ุชูุตู ูโุดูุฏ ุชุง:

- latency ฺฉูุชุฑ ุดูุฏ.
- API ู ุฑุจุงุช ุฑู ฺฉ ุฏุงููู ูุดุชุฑฺฉ ูุฑุงุฑ ฺฏุฑูุฏ.

ูุฑุงุญู ฺฉู (ูุทุงุจู ุทุฑุญ `NEW_FEATURES_IMPLEMENTATION.md`):

1. ุฑุงูโุงูุฏุงุฒ ฺฉ ูุจโุณุฑูุฑ (ูุซูุงู Nginx) ุฑู ุณุฑูุฑ.
2. ุตุฏูุฑ/ูุตุจ ฺฏูุงู SSL ูุนุชุจุฑ (Letโs Encrypt ุง ูุดุงุจู).
3. ุงุฌุฑุง ุณุฑูุณ ูพุงุชูู (ุฑุจุงุช + API) ูพุดุช ฺฉ reverse proxy.
4. ุชูุธู Webhook ุจุฑุง ุฑุจุงุช:
   - ุงุณุชูุงุฏู ุงุฒ ูุชุฏ `set_webhook` (ุฏุฑ ฺฉุฏ ูุดุงุจู ูููููโ ููุฌูุฏ ุฏุฑ NEW_FEATURES_IMPLEMENTATION).

> **ููโุฑุงุณุชุง ุจุง ููโุงูพ:** ุจูุชุฑ ุงุณุช ูุณุฑ `WEBHOOK_PATH` ู ูุณุฑ `MINIAPP_URL` ุฑู ฺฉ ุฏุงููู ุชูุธู ุดููุฏ. ูุซุงู:
>
> - Webhook: `https://your-domain.com/telegram/webhook`
> - Mini App: `https://your-domain.com/miniapp`

### ณ.ณ. ุงุฌุฑุง ุณุฑูุณ ูพุงุชูู ุจูโุนููุงู Systemd Service (ููููู ูพุดููุงุฏ)

> ุงู ุจุฎุด ฺฉ ุทุฑุงุญ ูพุดููุงุฏ ุงุณุชุ ูุงู ูุงูุน service ุฏุฑ ุฑูพู ูุฌูุฏ ูุฏุงุฑุฏ.

```ini
[Unit]
Description=CODM Attachments Bot + MiniApp
After=network.target

[Service]
User=botuser
WorkingDirectory=/opt/codm-bot-modular
Environment="PYTHONUNBUFFERED=1"
EnvironmentFile=/opt/codm-bot-modular/.env
ExecStart=/usr/bin/python main.py
Restart=always

[Install]
WantedBy=multi-user.target
```

---

## ด. ุงุณุชูุฑุงุฑ Frontend ููโุงูพ

### ด.ฑ. ุณุงุฎุช Frontend

- ุงฺฏุฑ ุงุฒ ฺฉ ูุฑููุฑฺฉ ูุซู React/Vue ุงุณุชูุงุฏู ุดูุฏ:

```bash
npm install
npm run build
```

- ุฎุฑูุฌ build (ูุซูุงู ูพูุดู `dist/` ุง `build/`) ุจุงุฏ ุฑู ูุจโุณุฑูุฑ ุณุฑู ุดูุฏ.

### ด.ฒ. ูุฒุจุงู ุฑู ููุงู ุฏุงููู

- ุชูุตู ูโุดูุฏ ูุงูโูุง ุงุณุชุงุชฺฉ ููโุงูพ ุฑู ููุงู ุฏุงูููโุง ฺฉู Webhook ุฏุงุฑุฏ ุณุฑู ุดููุฏุ ุจุฑุง ูุซุงู:
  - `https://your-domain.com/miniapp/index.html`
- ูพฺฉุฑุจูุฏ Nginx ููููู:

```nginx
location /miniapp/ {
    root /var/www/codm-miniapp;
    try_files $uri $uri/ /miniapp/index.html;
}
```

### ด.ณ. ุชูุธู URL ุฏุฑ ูพุฑูฺู

- ููุฏุงุฑ `MINIAPP_URL` ุฏุฑ `.env` ุจุงุฏ ุฏููุงู ูุทุงุจู ูุณุฑ ูุงูุน ุจุงุดุฏุ ูุซุงู:

```bash
MINIAPP_URL=https://your-domain.com/miniapp
```

- ุฏุฑ ฺฉุฏ ุจุงุช (ุทุจู ุทุฑุงุญ `IMPLEMENTATION.md`) ุงู URL ุฏุฑ `WebAppInfo` ุงุณุชูุงุฏู ูโุดูุฏ ุชุง ุฏฺฉูู ููโุงูพ ุฑุง ุจุณุงุฒุฏ.

---

## ต. ุชูุธูุงุช ุฏุฑ BotFather

ุจุฑุง ุงูฺฉู ุฏฺฉูู ููโุงูพ ุจูโุฏุฑุณุช ฺฉุงุฑ ฺฉูุฏ:

1. ุฏุฑ BotFather ุฏุณุชูุฑ `/mybots` โ ุงูุชุฎุงุจ ุฑุจุงุช.
2. ุจุฎุด **Menu Button / Web App** (ุจุณุชู ุจู UI ุชูฺฏุฑุงู ููฺฉู ุงุณุช ูุชูุงูุช ูุงูโฺฏุฐุงุฑ ุดุฏู ุจุงุดุฏ).
3. ุชูุธู ุนููุงู ู URL ููโุงูพ:
   - Title: ูุซูุงู `CODM Attachments`
   - URL: `https://your-domain.com/miniapp`

> ุชูุฌู: ุญุช ุงฺฏุฑ BotFather ุชูุธูุงุช ุจุฑุง Web App ูุฏุงุดุชู ุจุงุดุฏุ ูโุชูุงู ุงุฒ ุฏฺฉููโูุง `InlineKeyboardButton` ุจุง `web_app=WebAppInfo(url=...)` ุฏุฑ ฺฉุฏ ุงุณุชูุงุฏู ฺฉุฑุฏ. ุฏุฑ ูุฑ ุฏู ุญุงูุช URL ุจุงุฏ ุจุง HTTPS ุจุงุดุฏ.

---

## ถ. ฺฺฉโูุณุช ูพุณ ุงุฒ ุงุณุชูุฑุงุฑ

ุจุนุฏ ุงุฒ ุงุณุชูุฑุงุฑุ ููุงุฑุฏ ุฒุฑ ุจุงุฏ ุจุฑุฑุณ ุดููุฏ (ุฌุฒุฆุงุช ุจุดุชุฑ ุฏุฑ `CHECKLIST.md`):

- **ุฑุจุงุช:**
  - `/start` ุจุฏูู ุฎุทุง ฺฉุงุฑ ูโฺฉูุฏ.
  - ููู ุงุตู ููุงุด ุฏุงุฏู ูโุดูุฏ.
  - ุฏุฑ ุตูุฑุช ูุนุงู ุจูุฏู ููโุงูพุ ุฏฺฉูู ยซ๐ฑ ููโุงูพยป ุฏุฑ ููู ุฏุฏู ูโุดูุฏ.

- **ููโุงูพ:**
  - ุจุง ฺฉูฺฉ ุฑู ุฏฺฉููุ Web App ุจุฏูู ุฎุทุง TLS ุจุงุฒ ูโุดูุฏ.
  - UI ูโุชูุงูุฏ ุฏุณุชูโูุงุ ุณูุงุญโูุง ู ุงุชฺููุชโูุง ุฑุง ุงุฒ API ุฏุฑุงูุช ู ููุงุด ุฏูุฏ.

- **Webhook (ุฏุฑ ุตูุฑุช ุงุณุชูุงุฏู):**
  - ูฺ ุฎุทุง `Webhook error` ุฏุฑ ูุงฺฏโูุง ุฏุฏู ููโุดูุฏ.
  - ูพุงูโูุง ุฌุฏุฏ ุจู ูููุน ุจู ุฑุจุงุช ูโุฑุณูุฏ.

- **ุขูุงูุชฺฉุณ:**
  - ูุชูุงุณุจ ุจุง ุชุนุงูู ฺฉุงุฑุจุฑ ุฏุฑ ููโุงูพุ ุฑฺฉูุฑุฏูุง ุฌุฏุฏ ุฏุฑ ุฌุฏุงูู `attachment_metrics` ู `user_attachment_engagement` ุซุจุช ูโุดููุฏ.
  - ุชุงุจุนโูุง `get_trending_attachments` ู `get_attachment_stats` ุฎุฑูุฌ ูุนููู ุฏุงุฑูุฏ.

---

## ท. ุชูุตูโูุง ุนูู ุจุฑุง Production

- **Logging ู ูุงูุชูุฑูฺฏ**
  - ูุนุงู ฺฉุฑุฏู ูุงฺฏโูุง ููุงุณุจ (ูุงููุฏ ููุฌูุฏ ุฏุฑ `utils/logger`).
  - ุฏุฑ ุตูุฑุช ูุงุฒุ ุงุณุชูุงุฏู ุงุฒ ุงุจุฒุงุฑูุง ูุงููุฏ Sentry/Prometheus (ูุทุงุจู `IMPROVEMENTS_GUIDE.md`).

- **Backup ุฏุชุงุจุณ**
  - ุชูุธู backup ุฏูุฑูโุง ุงุฒ PostgreSQL.

- **ุงุณุชูุงุฏู ุงุฒ Webhook ุฏุฑ ููุงุจู Polling**
  - ุจุฑุง ูุญุท production ู ูุฎุตูุตุงู ุฏุฑ ุญุถูุฑ ููโุงูพุ Webhook ูุนูููุงู ฺฏุฒูู ุจูุชุฑ ุงุณุช.

ุจุง ุฑุนุงุช ุงู ุฑุงูููุง ูโุชูุงูุฏ ููโุงูพ ู ุฑุจุงุช ุฑุง ุฑู ฺฉ ุณุฑูุฑ ุงูู ู ูพุงุฏุงุฑ ูุณุชูุฑ ฺฉุฑุฏู ู ุชุฌุฑุจู ฺฉุงุฑุจุฑ ุฎูุจ ุฏุฑ ุชูฺฏุฑุงู ุงุฑุงุฆู ุฏูุฏ.
