# ูุนูุงุฑ ููโุงูพ ุชูฺฏุฑุงู CODM Attachments

ุงู ุณูุฏ ูุนูุงุฑ ฺฉู ุณุณุชู ุฑุง ุจุง ุชูุฑฺฉุฒ ุจุฑ ููโุงูพ ุชูฺฏุฑุงู ุชูุถุญ ูโุฏูุฏ ู ูุดุงู ูโุฏูุฏ ููโุงูพ ฺฺฏููู ุฑู ูุนูุงุฑ ููุฌูุฏ ุฑุจุงุช ุณูุงุฑ ูโุดูุฏ.

---

## ฑ. ููุง ฺฉู ุณุณุชู

ุณุณุชู ุงุฒ ฺูุฏ ูุงู ุงุตู ุชุดฺฉู ุดุฏู ุงุณุช:

- **ฺฉูุงูุช ุชูฺฏุฑุงู**
  - ฺฉุงุฑุจุฑ ุฑุจุงุช ุฑุง ุงุณุชุงุฑุช ูโฺฉูุฏ ู ุฑู ยซููโุงูพยป ฺฉูฺฉ ูโฺฉูุฏ.
  - ููโุงูพ ุจูโุตูุฑุช Web App ุฏุงุฎู ุฎูุฏ ุชูฺฏุฑุงู ุจุงุฒ ูโุดูุฏ.

- **Frontend ููโุงูพ (Web App)**
  - ฺฉ ุจุฑูุงูู ูุจ (SPA ุง ุตูุญุงุช ุณุงุฏู) ฺฉู ุฏุงุฎู WebView ุชูฺฏุฑุงู ุงุฌุฑุง ูโุดูุฏ.
  - ุงุฒ ุทุฑู HTTP/JSON ุจุง API ุจฺฉโุงูุฏ ุตุญุจุช ูโฺฉูุฏ.

- **Bot Backend (ุฑุจุงุช ูุนู)**
  - ูุจุชู ุจุฑ `python-telegram-bot` ู ูุนูุงุฑ ูุงฺููุงุฑ.
  - ูุฏุฑุช ููููุงุ deep-link ูุงุ ุงุญุฑุงุฒ ููุช `initData` ููโุงูพ ู ุงุฑุณุงู ููฺฉ ููโุงูพ.

- **ูุงู ุฏุงุฏู ู ููุทู ฺฉุณุจโูฺฉุงุฑ**
  - `DatabaseAdapter` ู ูพุงุฏูโุณุงุฒ PostgreSQL (`DatabasePostgresProxy`).
  - ูุงฺููโูุง ุขูุงูุชฺฉุณ (`AttachmentAnalytics`, `AnalyticsPostgres`).

- **ุฏุชุงุจุณ PostgreSQL**
  - ุฐุฎุฑู ุณูุงุญโูุงุ ุงุชฺููุชโูุงุ ุขูุงุฑ ุงุณุชูุงุฏูุ ฺฉุงุฑุจุฑุงูุ ฺฉุงูุงูโูุง ู ...

### ฑ.ฑ. ุฏุงฺฏุฑุงู ุณุทุญ ุจุงูุง

```mermaid
flowchart LR
    TG[ฺฉุงุฑุจุฑ ุฏุฑ ุชูฺฏุฑุงู] -->|ูพุงู / ููู| BOT[ุฑุจุงุช CODM Attachments]
    BOT -->|ุงุฑุณุงู ุฏฺฉูู Mini App ุจุง URL| TG
    TG -->|ุจุงุฒ ฺฉุฑุฏู Web App| MINI[Frontend ููโุงูพ]
    MINI -->|ุฏุฑุฎูุงุณุชโูุง HTTP/JSON| API[(API ุจฺฉโุงูุฏ / ุฑุจุงุช)]
    API --> DB[(PostgreSQL)]
    API --> ANALYTICS[(Attachment Analytics)]
```

- ุฏุฑ ุนููุ **Bot Backend ู API ุจฺฉโุงูุฏ** ูโุชูุงููุฏ ฺฉ ุณุฑูุณ ูุงุญุฏ ุจุงุดูุฏ (ูพุฑูุณู ูพุงุชูู ูุนู) ุง ุฏู ุณุฑูุณ ุฌุฏุง (ูุซูุงู FastAPI ุฏุฑ ฺฉูุงุฑ ุฑุจุงุช).

---

## ฒ. ูุนูุงุฑ ูุนู ุฑุจุงุช (ุฒุฑุณุงุฎุช ูุดุชุฑฺฉ)

### ฒ.ฑ. ูุงู ูุฑูุฏ ู Application

- ูุงู ุงุตู: `main.py`
  - ุณุงุฎุช ุดุก ุงุตู bot (ูุซูุงู `CODMAttachmentsBot`).
  - ุงุฌุงุฏ `Application` ุชูฺฏุฑุงู ู ุฑุงูโุงูุฏุงุฒ polling.

- ฺฉูุงุณ ฺฉุงุฑุฎุงูู:
  - `app/factory.py` โ ฺฉูุงุณ `BotApplicationFactory`
    - `create_application()` โ ุณุงุฎุช Application ู ุชูุธู `bot_data`.
    - `setup_handlers()` โ ุซุจุช handler ูุง ุงุฒ ุทุฑู registries.

### ฒ.ฒ. ูุงู ููุฏูุฑูุง (Handlers Layer)

- Registryูุง:
  - `app/registry/UserHandlerRegistry`ุ `AdminHandlerRegistry`ุ `InlineHandlerRegistry` ู ...
- ููุฏูุฑูุง ฺฉุงุฑุจุฑ:
  - ูุณุฑ: `handlers/user/modules/`
  - ูุซุงู ููู:
    - `navigation/main_menu.py` โ ฺฉูุงุณ `MainMenuHandler` ู ูุชุฏ `start`
      - ุณุงุฎุช ฺฉุจูุฑุฏ ุงุตู (reply keyboard).
      - ุงุณุชูุงุฏู ุงุฒ `kb(...)` ู `t(...)` ุจุฑุง ูุชูโูุง ฺูุฏุฒุจุงูู.
- ุงู ูุงู ุฏุฑ ุขูุฏู ููุทูโ ุงุตู **ุงุถุงูู ฺฉุฑุฏู ุฏฺฉูู Mini App** ุฎูุงูุฏ ุจูุฏ.

### ฒ.ณ. ูุงู ุฏุชุงุจุณ ู ฺฉุด

- Adapter ูุฑฺฉุฒ:
  - `core/database/database_adapter.DatabaseAdapter`
  - ุงุณุชูุงุฏู ุงุฒ ุงูฺฏู **Adapter** ู **Proxy** ุจุฑุง ุงุชุตุงู ุจู PostgreSQL.
  - ูุชุฏูุง ฺฉูุฏ ุจุฑุง ููโุงูพ:
    - `get_weapons_in_category`, `get_all_attachments`, `get_top_attachments`,
      `get_season_top_attachments`, `get_attachment_by_id`, `search_attachments_fts`.
- ูพุงุฏูโุณุงุฒ PostgreSQL:
  - `core/database/database_pg_proxy.DatabasePostgresProxy`
  - ุญุงู SQL ูุงูุน ุฑู ุฌุฏุงูู `weapons`, `attachments`, `user_attachment_engagement` ู ...
- ฺฉุด:
  - ุงุฒ ุทุฑู `core/cache/cache_manager` ุจุฑุง ุจุฑุฎ ูุชุฏูุง (ูุซูุงู ุดูุงุฑุด ุฏุณุชูโูุง).

### ฒ.ด. ูุงู ุขูุงูุชฺฉุณ

- **AttachmentAnalytics** (`utils/attachment_analytics.py`)
  - ุฑุฏุงุจ view/click/share/copy ู rating.
  - ุฐุฎุฑู ุฑูุฏุงุฏูุง ุฏุฑ ุฌุฏูู `attachment_metrics` ู ุชุฌูุน ุฏุฑ `attachment_performance`.
  - ุชููุฏ ูุณุชโูุง:
    - Trending Attachments (`get_trending_attachments`)
    - Underperforming Attachments (`get_underperforming_attachments`)
- **AnalyticsPostgres** (`utils/analytics_pg.py`)
  - ุขูุงุฑ ฺฉุงูุงูโูุง ุงุฌุจุงุฑ ู ูู ุชุจุฏู ฺฉุงุฑุจุฑุงู.
  - ุจุฑุง ููโุงูพ ูโุชูุงูุฏ ุจุฑุง ูุงูุชูุฑูฺฏ ฺฉู ฺฉุงุฑุจุฑุงู ุจุงุช ุงุณุชูุงุฏู ุดูุฏ.

---

## ณ. ูุนูุงุฑ ุฏุงุฏู ุจุฑุง ููโุงูพ

### ณ.ฑ. ุฌุฏุงูู ุงุตู

ุจุฑ ุงุณุงุณ `scripts/init_postgres.sql` ุฌุฏุงูู ุฒุฑ ุจุฑุง ููโุงูพ ููู ูุณุชูุฏ:

- **`weapon_categories`**
  - ูฺฏูโุฏุงุฑ ุฏุณุชูโูุง ุณูุงุญ (assault_rifle, smg, ...).

- **`weapons`**
  - ุณูุงุญโูุง ุจุง `category_id` ู `name`.

- **`attachments`**
  - ุงุชฺููุชโูุง ุจุฑุง ูุฑ ุณูุงุญ ู ููุฏ (`mode IN ('br','mp')`).
  - ููุฏูุง ููู ุจุฑุง ููโุงูพ:
    - `code`, `name`, `image_file_id`, `is_top`, `is_season_top`, `order_index`,
    - ููุฏูุง ุขูุงุฑ ูุงููุฏ `total_views`, `total_clicks` (ุฏุฑ ฺฉุฏ ุขูุงูุชฺฉุณ ุงุณุชูุงุฏู ูโุดููุฏ).

- **`user_attachment_engagement`**
  - ุนููฺฉุฑุฏ ฺฉุงุฑุจุฑุงู ูุณุจุช ุจู ุงุชฺููุชโูุง (rating, total_views, total_clicks, ...).

- **`attachment_metrics` / `attachment_performance`**
  - ุฐุฎุฑู ุฑูุฏุงุฏูุง ุฑุฒ (metrics) ู ุงูุชุงุฒุฏู ุชุฌูุนโุดุฏู.

ุงู ุณุงุฎุชุงุฑ ุงุฌุงุฒู ูโุฏูุฏ ููโุงูพ **ููุท ุฎูุงูุฏู** (read-only) ุจุงุดุฏ ู ุชูุงู ูุญุชูุง ุฑุง ุงุฒ ุฏุงุฏูโูุง ููุฌูุฏ ุจฺฏุฑุฏ.

### ณ.ฒ. ูุฏู ุฏุงุฏู ุฏุฑ API ููโุงูพ

ุฏุฑ ุณุทุญ API (ุทุฑุงุญ ูพุดููุงุฏ ุฏุฑ `API_SPEC.md`) ูุฏู ุฏุงุฏู ุชูุฑุจุงู ุจู ุตูุฑุช ุฒุฑ ุฎูุงูุฏ ุจูุฏ:

- `Category`: `{ key: string, name: string }`
- `Weapon`: `{ name: string, category: string }`
- `Attachment`: `{ id, code, name, image, top, season_top, stats }`
- `AttachmentStats`: `{ views, clicks, rating, popularity, trending }`

ุชูุงู ุงู ุฏุงุฏูโูุง ุงุฒ ูุชุฏูุง ููุฌูุฏ `DatabaseAdapter` ู `AttachmentAnalytics` ุงุณุชุฎุฑุงุฌ ูโุดููุฏ.

---

## ด. ูุนูุงุฑ ูพุดููุงุฏ ุจุฑุง ููโุงูพ

### ด.ฑ. ูุงู Frontend (Web App)

- ุชฺฉููููฺ ูพุดููุงุฏ:
  - ูุฑ ูุฑููุฑฺฉ SPA (React, Vue, Svelte) ุง ุญุช HTML/JS ุณุงุฏู.
  - ุจุงุฏ ุฏุงุฎู WebView ุชูฺฏุฑุงู ุจุง `WebAppInfo` ุจุงุฒ ุดูุฏ.
- ุตูุญุงุช ุงุตู:
  - ุตูุญู ุงูุชุฎุงุจ ุฏุณุชู (Category Selector).
  - ุตูุญู ุงูุชุฎุงุจ ุณูุงุญ (Weapon List ุจุฑุง ูุฑ ุฏุณุชู).
  - ุตูุญู ูุณุช ุงุชฺููุชโูุง (Top / All / Season Top).
  - ุตูุญู ยซุชุฑูุฏูุง ู ูพุดููุงุฏูุงยป (Trending / Suggested).

### ด.ฒ. API Backend

- ูโุชูุงูุฏ ฺฉ ุงุฒ ุฏู ุญุงูุช ุจุงุดุฏ:
  1. **ููุงู ูพุฑูุณูโ ุฑุจุงุช**: ุงุถุงูู ฺฉุฑุฏู ฺฉ ูุจโุณุฑูุฑ ุณุจฺฉ (ูุซูุงู FastAPI ุง Flask) ุฏุฑ ฺฉูุงุฑ `python-telegram-bot`.
  2. **ุณุฑูุณ ุฌุฏุง**: ฺฉ ุณุฑูุณ ูุจ ฺฉู ุจุง ููุงู ุฏุชุงุจุณ PostgreSQL ฺฉุงุฑ ูโฺฉูุฏ.
- ุฏุฑ ูุฑ ุฏู ุญุงูุช:
  - ุจุฑุง ุฎูุงูุฏู ุฏุงุฏูโูุง ุงุฒ `DatabaseAdapter` ุงุณุชูุงุฏู ูโุดูุฏ.
  - ุจุฑุง ุขูุงุฑ ูุญุธูโุง ุงุฒ `AttachmentAnalytics` ุงุณุชูุงุฏู ูโุดูุฏ.

### ด.ณ. ุงุฑุชุจุงุท Bot โ Mini App

```mermaid
sequenceDiagram
    participant U as User
    participant TG as Telegram Client
    participant B as Bot Backend
    participant W as Web App

    U->>TG: ุจุงุฒ ฺฉุฑุฏู ฺุช ุฑุจุงุช
    U->>B: /start
    B->>TG: ุงุฑุณุงู ฺฉุจูุฑุฏ ุจุง ุฏฺฉูู ยซ๐ฑ ููโุงูพยป
    U->>TG: ฺฉูฺฉ ุฑู ุฏฺฉูู ููโุงูพ
    TG->>W: ุจุงุฒ ฺฉุฑุฏู URL ููโุงูพ (WebApp)
    W->>B: ุฏุฑุฎูุงุณุชโูุง API (ูุณุช ุณูุงุญโูุงุ ุงุชฺููุชโูุงุ ุชุฑูุฏูุง)
    B->>DB: ุฎูุงูุฏู ุงุฒ PostgreSQL
    B->>W: ูพุงุณุฎ JSON
```

- ุงุญุฑุงุฒ ููุช ู ุงุนุชุจุงุฑุณูุฌ session ููโุงูพ ุงุฒ ุทุฑู `initData` ุงูุฌุงู ูโุดูุฏ (ุดุฑุญ ุฏุฑ `SECURITY.md`).

---

## ต. ููุงุท ุงุชุตุงู ฺฉูุฏ ุฏุฑ ฺฉุฏ

- **Main Menu Handler** (`handlers/user/modules/navigation/main_menu.py`)
  - ุฌุง ููุงุณุจ ุจุฑุง ุงุถุงูู ฺฉุฑุฏู ุฏฺฉูู Mini App ุจู ฺฉุจูุฑุฏ.
  - ุงุฒ `kb("menu.buttons.miniapp", lang)` ุจุฑุง ูุชู ุฏฺฉูู ุงุณุชูุงุฏู ูโุดูุฏ.

- **DatabaseAdapter + DatabasePostgresProxy**
  - ูุจูุง ุชูุงู ฺฉูุฆุฑโูุง read-only ุจุฑุง ููโุงูพ.

- **AttachmentAnalytics**
  - ุจุฑุง ุซุจุช view/click ุฏุฑ ุตูุฑุช ฺฉู frontend ููโุงูพ ุงู ุฑูุฏุงุฏูุง ุฑุง ุจู API ฺฏุฒุงุฑุด ุฏูุฏ.

- **NEW_FEATURES_IMPLEMENTATION.md / ุจุฎุด Webhook Mode**
  - ุฏุฑ ุตูุฑุช ฺฉู ุฑุจุงุช ุฏุฑ ุญุงูุช Webhook ุงุฌุฑุง ุดูุฏุ ูโุชูุงู API ููโุงูพ ุฑุง ุฑู ููุงู ุณุฑูุฑ ู ุฏุงููู ูุฑุงุฑ ุฏุงุฏ.

---

## ถ. ุฌูุนโุจูุฏ

- ูุนูุงุฑ ูุนู ุฑุจุงุชุ ุฏุชุงุจุณ ู ุขูุงูุชฺฉุณ **ุจุฑุง ููโุงูพ ุขูุงุฏูโุงูุฏ** ู ูุงุฒ ุจู ุจุงุฒููุณ ูุฏุงุฑูุฏ.
- ููโุงูพ ุฏุฑ ูุงูุน ฺฉ ูุงูโ **ููุงุด (Presentation Layer)** ุงุณุช ฺฉู ุฑู ุงู ุฒุฑุณุงุฎุช ุณูุงุฑ ูโุดูุฏ.
- ุทุฑุงุญ ุฏูู ฺฏุงูโูุง ูพุงุฏูโุณุงุฒ ู API ุฏุฑ `IMPLEMENTATION.md` ู `API_SPEC.md` ุขูุฏู ุงุณุช.
