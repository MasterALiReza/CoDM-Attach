# ุชุณุชโูุง ู ุงุนุชุจุงุฑุณูุฌ ููโุงูพ ุชูฺฏุฑุงู CODM Attachments

ุงู ุณูุฏ ุณูุงุฑููุง ุชุณุชุ ุฑูุดโูุง ุชุถูู ฺฉูุช ู ูุนุงุฑูุง ุนููฺฉุฑุฏ ููโุงูพ ุฑุง ุจุฑ ุงุณุงุณ ูุนูุงุฑ ู ฺฉุฏ ูุนู ูพุฑูฺู ุชูุถุญ ูโุฏูุฏ.

---

## ฑ. ุงุณุชุฑุงุชฺ ฺฉู ุชุณุช

### ฑ.ฑ. ุณุทูุญ ุชุณุช

- **ุชุณุช ูุงุญุฏ (Unit Tests)**
  - ุชูุงุจุน/ฺฉูุงุณโูุง ูุงู API (ูุซูุงู viewูุง FastAPI/Flask).
  - ูุงู ุฏุงุฏู (ูุชุฏูุง `DatabaseAdapter` ฺฉู ุจุฑุง ููโุงูพ ุงุณุชูุงุฏู ูโุดููุฏ).
  - ูุงฺููโูุง ุขูุงูุชฺฉุณ (`AttachmentAnalytics`).

- **ุชุณุช ฺฉูพุงุฑฺู (Integration Tests)**
  - ุฌุฑุงู ฺฉุงูู: API โ PostgreSQL (ุจุง ุฏุชุงุจุณ ุชุณุช).
  - ุงุนุชุจุงุฑุณูุฌ `initData` ู ุงุญุฑุงุฒ ููุช ุฏุฑุฎูุงุณุชโูุง.

- **ุชุณุช ุงูุชูุง ุจู ุงูุชูุง (E2E)**
  - ุณูุงุฑููุง ูุงูุน ุฏุฑ ุชูฺฏุฑุงู: ฺฉุงุฑุจุฑ โ ุจุงุช โ ููโุงูพ โ API โ ุฏุชุงุจุณ.
  - ุงุณุชูุงุฏู ุงุฒ ฺฉ ุฑุจุงุช ุชุณุช ู ฺฉ ุฏุงููู ุชุณุช.

### ฑ.ฒ. ุงุจุฒุงุฑูุง ูพุดููุงุฏ

- ูพุงุชูู:
  - `pytest`, `pytest-asyncio`, `pytest-cov` (ููุงูโูุง ฺฉู ุฏุฑ `requirements.txt` ุขูุฏูโุงูุฏ).
- Frontend:
  - ุชุณุชโูุง ุฏุณุช/ุฎูุฏฺฉุงุฑ (ุจู ุงูุชุฎุงุจ ุดูุงุ ุงู ุณูุฏ ููุท ุณูุช ุณุฑูุฑ ุฑุง ูพูุดุด ูโุฏูุฏ).

---

## ฒ. ุณูุงุฑููุง ุชุณุช ฺฉุงุฑุจุฑุฏ (Functional Scenarios)

### ฒ.ฑ. ุจุงุฒ ุดุฏู ููโุงูพ ู ุฏุฑุงูุช ุฏุงุฏู ุงููู

**ูุฏู:** ุงุทููุงู ุงุฒ ุงูฺฉู ฺฉุงุฑุจุฑ ูโุชูุงูุฏ ููโุงูพ ุฑุง ุจุงุฒ ฺฉูุฏ ู ุฏุงุฏูโูุง ุงููู ุฑุง ุฏุฑุงูุช ููุงุฏ.

- **ูพุดโุดุฑุท:**
  - ุฑุจุงุช ูุนุงู ู ูุชุตู ุจู PostgreSQL.
  - Mini App URL ุฏุฑ `.env` ู BotFather ุชูุธู ุดุฏู ุจุงุดุฏ.

- **ฺฏุงูโูุง:**
  1. ฺฉุงุฑุจุฑ `/start` ุฑุง ุฏุฑ ุฑุจุงุช ูโูุฑุณุชุฏ.
  2. ููู ุงุตู ููุงุด ุฏุงุฏู ูโุดูุฏ ู ุฏฺฉูู ยซ๐ฑ ููโุงูพยป ูุงุจู ูุดุงูุฏู ุงุณุช.
  3. ฺฉุงุฑุจุฑ ุฑู ุฏฺฉูู ฺฉูฺฉ ูโฺฉูุฏุ Web App ุฏุฑ ุชูฺฏุฑุงู ุจุงุฒ ูโุดูุฏ.
  4. Frontend `initData` ุฑุง ฺฏุฑูุชู ู ุจู API `/miniapp/v1/auth/verify` (ุง endpoint ูุดุงุจู) ุงุฑุณุงู ูโฺฉูุฏ.
  5. API ูพุณ ุงุฒ ุงุนุชุจุงุฑุณูุฌุ ฺฉ ูพุงุณุฎ ูููู ุจุง ุงุทูุงุนุงุช ูพุงู (ุฒุจุงูุ ุขุฏ ฺฉุงุฑุจุฑุ ุชูุธูุงุช) ุจุฑูโฺฏุฑุฏุงูุฏ.

- **ุงูุชุธุงุฑ:**
  - ูฺ ุฎุทุง HMAC / ุงูุถุง ูุงูุนุชุจุฑ ุฏุฑ ูุงฺฏโูุง.
  - ูพุงุณุฎ API ุฏุฑ ฺฉูุชุฑ ุงุฒ ~ณฐฐms.

### ฒ.ฒ. ูุดุงูุฏู ูุณุช ุฏุณุชูโูุง ู ุณูุงุญโูุง

- **ฺฏุงูโูุง:**
  1. Frontend ุฏุฑุฎูุงุณุช `GET /miniapp/v1/categories` ุฑุง ุงุฑุณุงู ูโฺฉูุฏ.
  2. API ุจุง ุงุณุชูุงุฏู ุงุฒ `DatabaseAdapter` ูุณุช ุฏุณุชูโูุง ุฑุง ุงุฒ `weapon_categories` ุง `WEAPON_CATEGORIES` ุจุฑูโฺฏุฑุฏุงูุฏ.
  3. ฺฉุงุฑุจุฑ ฺฉ ุฏุณุชู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏุ ุฏุฑุฎูุงุณุช `GET /miniapp/v1/weapons?category=...` ุงุฑุณุงู ูโุดูุฏ.

- **ุงูุชุธุงุฑ:**
  - ุฏุณุชูโูุง ู ุณูุงุญโูุง ุจุง ูุงูโูุง ุตุญุญ ู ุจุฏูู ุชฺฉุฑุงุฑ ุจุฑฺฏุฑุฏุงูุฏู ุดููุฏ.
  - ุฏุฑ ุตูุฑุช ุฏุณุชู ูุงูุนุชุจุฑุ API ุฎุทุง ูุนุชุจุฑ (ูุซูุงู `400` ุจุง ูพุงู ูุงุถุญ) ุจุฏูุฏ.

### ฒ.ณ. ูุดุงูุฏู ุงุชฺููุชโูุง ฺฉ ุณูุงุญ

- **ฺฏุงูโูุง:**
  1. ุฏุฑุฎูุงุณุช `GET /miniapp/v1/attachments?category=...&weapon=...&mode=br` ุงุฑุณุงู ูโุดูุฏ.
  2. API ุจุง ุงุณุชูุงุฏู ุงุฒ ูุชุฏูุง `get_top_attachments`ุ `get_all_attachments` ู (ุฏุฑ ุตูุฑุช ูุงุฒ) `get_season_top_attachments_for_weapon` ูพุงุณุฎ ุฑุง ูโุณุงุฒุฏ.

- **ุงูุชุธุงุฑ:**
  - ุณุงุฎุชุงุฑ ูพุงุณุฎ ุดุงูู ุจุฎุดโูุง `top`, `all`, `season_top` ุจุงุดุฏ.
  - ุดูุงุฑุด ุงููุงู ู ููุงุฏุฑ `code`, `name`, `image`, `top`, `season_top` ุจุง ุฏุงุฏูโูุง ูุงูุน DB ุณุงุฒฺฏุงุฑ ุจุงุดุฏ.

### ฒ.ด. ุตูุญู ยซุชุฑูุฏูุงยป (Trending)

- **ฺฏุงูโูุง:**
  1. ุฏุฑุฎูุงุณุช `GET /miniapp/v1/trending?limit=10` ูุฑุณุชุงุฏู ูโุดูุฏ.
  2. API ุงุฒ `AttachmentAnalytics.get_trending_attachments` ุงุณุชูุงุฏู ูโฺฉูุฏ.

- **ุงูุชุธุงุฑ:**
  - ูพุงุณุฎ ุญุงู ููุฏูุง ูุงููุฏ `id`, `name`, `code`, `weapon`, `category`, `trending_score`, `popularity_score`, `total_views` ุจุงุดุฏ.
  - ููุงุฑุฏ ุชุณุช/ุชุณุชโุฏุชุง ฺฉู ุฏุฑ ฺฉุฏ ููุชุฑ ุดุฏูโุงูุฏ (ูุซู ูุงูโูุง ุญุงู `Test`) ุฏุฑ ูุชุฌู ุฏุฏู ูุดููุฏ.

### ฒ.ต. ุซุจุช ุฑูุฏุงุฏูุง ฺฉุงุฑุจุฑ (Views/Clicks/Rating)

- **ฺฏุงูโูุง:**
  1. Frontend ุฑู ููุงุด ฺฉ ุงุชฺููุช ุฑูุฏุงุฏ `view` ุฑุง ุจู `POST /miniapp/v1/events` ุงุฑุณุงู ูโฺฉูุฏ.
  2. ุฑู ฺฉูฺฉ/ุงูุชุฎุงุจ ุงุชฺููุชุ ุฑูุฏุงุฏ `click` ู ุฏุฑ ุตูุฑุช ุงูุชุงุฒุฏูุ ุฑูุฏุงุฏ `rate` ุงุฑุณุงู ูโุดูุฏ.
  3. API ุงู ุฑูุฏุงุฏูุง ุฑุง ุจู ูุชุฏูุง `AttachmentAnalytics.track_view/track_click/track_rating` ูโูุฑุณุชุฏ.

- **ุงูุชุธุงุฑ:**
  - ุฏุฑ ุฌุฏูู `attachment_metrics` ุฑุฏูโูุง ุฌุฏุฏ ูุทุงุจู ุจุง ุฑูุฏุงุฏูุง ุซุจุช ุดููุฏ.
  - ุฏุฑ ุฌุฏูู `user_attachment_engagement`ุ ุณุชููโูุง `total_views`, `total_clicks`, `rating` ุจูโุฏุฑุณุช ุจูโุฑูุฒุฑุณุงู ุดููุฏ.

### ฒ.ถ. ุฌุณุชุฌู

- **ฺฏุงูโูุง:**
  1. ฺฉุงุฑุจุฑ ุฏุฑ ููโุงูพ ุนุจุงุฑุช ุฌุณุชุฌู ุฑุง ูุงุฑุฏ ูโฺฉูุฏ.
  2. Frontend ุฏุฑุฎูุงุณุช `GET /miniapp/v1/search?q=...` ุฑุง ูโูุฑุณุชุฏ.
  3. API ุงุฒ `DatabaseAdapter.search_attachments_fts` ุง `search_attachments` ุงุณุชูุงุฏู ูโฺฉูุฏ.

- **ุงูุชุธุงุฑ:**
  - ูุชุงุฌ ุจุง ุชูุฌู ุจู `code`, `name` ู ูุงู ุณูุงุญ ูุงุฒ/ูุชู ุตุญุญ ุจุงุดูุฏ.
  - ุฏุฑ ุตูุฑุช ุฎุงู ุจูุฏู ูุชุงุฌุ ูพุงู ููุงุณุจ ุฏุฑ UI ููุงุด ุฏุงุฏู ุดูุฏ.

---

## ณ. ุชุณุชโูุง ุงููุช

### ณ.ฑ. ุงุนุชุจุงุฑุณูุฌ `initData`

- **ุณูุงุฑู:** ุงุฑุณุงู `initData` ูุนุชุจุฑ ู ูุงูุนุชุจุฑ ุจู endpoint ุงุญุฑุงุฒ ููุช.

- **ููุงุฑุฏ ุชุณุช:**
  - `initData` ุฏุณุชฺฉุงุฑโุดุฏู (ูุซูุงู ุชุบุฑ `user.id`).
  - `initData` ูุฏู (ุงุณุชูุงุฏู ูุฌุฏุฏ ุงุฒ ุฏุงุฏู ูพุณ ุงุฒ ุงููุถุง session).
  - ุญุฐู ููุฏ `hash` ุง ุงุถุงูู ฺฉุฑุฏู ูพุงุฑุงูุชุฑูุง ุบุฑููุชุธุฑู.

- **ุงูุชุธุงุฑ:**
  - ุฏุฑ ููู ููุงุฑุฏ ูุงูุนุชุจุฑุ API ูพุงุณุฎ ุฎุทุง ูุงุถุญ ู ุจุฏูู ูุดุช ุงุทูุงุนุงุช ุญุณุงุณ ุจุฏูุฏ.
  - ุชููุง ุฏุฑ ุตูุฑุช ุงูุถุง ูุนุชุจุฑ ู ุชุทุงุจู ุจุง `BOT_TOKEN` session ุณุงุฎุชู ุดูุฏ.

### ณ.ฒ. Rate Limiting ู ุฌููฺฏุฑ ุงุฒ ุณูุกุงุณุชูุงุฏู

- ุชุณุช ุงุฑุณุงู ุญุฌู ุจุงูุง ุงุฒ ุฏุฑุฎูุงุณุชโูุง ุจู endpoint ูุง:
  - `/miniapp/v1/search`
  - `/miniapp/v1/events`

- ุงูุชุธุงุฑ:
  - ุฏุฑ ุตูุฑุช ุชุฌุงูุฒ ุงุฒ ุขุณุชุงูู ุชุนุฑูโุดุฏูุ API ุฎุทุง ููุงุณุจ (ูุซูุงู `429 Too Many Requests`) ุง ูพุงู ูุญุฏูุฏฺฉููุฏู ุจุฑฺฏุฑุฏุงูุฏ.

---

## ด. ุชุณุชโูุง ุนููฺฉุฑุฏ (Performance)

### ด.ฑ. ูุนุงุฑูุง ูพุดููุงุฏ

- **API Read (GET)**
  - ุฒูุงู ูพุงุณุฎ ูุนููู: ุฒุฑ ณฐฐms ุจุฑุง ุฏุฑุฎูุงุณุชโูุง ุณุงุฏู (categories/weapons).
  - ุญุฏุงฺฉุซุฑ: ุฒุฑ ฑฐฐฐms ุญุช ุฏุฑ ุดุฑุงุท ูุดุงุฑ ููุทู.

- **API Write (Events)**
  - ุซุจุช ุฑูุฏุงุฏ view/click ุจุงุฏ ุชูุฑุจุงู ููุดู ุฒุฑ ฒฐฐms ุจุงุดุฏ.

### ด.ฒ. ุฑูุด ุชุณุช

- ุงุณุชูุงุฏู ุงุฒ ุงุจุฒุงุฑูุง ูุงููุฏ:
  - `locust`, `k6`, ุง ุญุช `ab`/`wrk` ุจุฑุง ุชุณุช ุณุงุฏู.
- ุณูุงุฑููุง:
  - ตฐโฑฐฐ ฺฉุงุฑุจุฑ ููโุฒูุงู ฺฉู:
    - ูุณุช ุณูุงุญโูุง ุฑุง ูโฺฏุฑูุฏ.
    - ุงุชฺููุชโูุง ุฑุง ูุดุงูุฏู ูโฺฉููุฏ.
    - ุฑูุฏุงุฏูุง view/click ุงุฑุณุงู ูโฺฉููุฏ.

---

## ต. ุชุณุชโูุง ุฑฺฏุฑุณูู

ูุฑ ุจุงุฑ ฺฉู ฺฉ ุงุฒ ููุงุฑุฏ ุฒุฑ ุชุบุฑ ฺฉูุฏุ ุจุงุฏ ูุฌููุนูโ ุชุณุชโูุง ููโุงูพ ุงุฌุฑุง ุดููุฏ:

- ุชุบุฑ ุฏุฑ ุงุณฺฉูุง ุฌุฏููโูุง `attachments`, `attachment_metrics`, `user_attachment_engagement`.
- ุชุบุฑ ุฏุฑ ูุชุฏูุง `DatabaseAdapter` ฺฉู ููโุงูพ ุจุฑ ุขูโูุง ุชฺฉู ุฏุงุฑุฏ.
- ุชุบุฑ ุฏุฑ ููุทู `AttachmentAnalytics` (ุจูโุฎุตูุต ุฑูุด ูุญุงุณุจู ุชุฑูุฏูุง ู ุงูุชุงุฒูุง).

---

## ถ. ฺฏุฒุงุฑุดโุฏู ู ูุงูุชูุฑูฺฏ

- ุชูุตู ูโุดูุฏ:
  - ุจุฑุง ุฎุทุงูุง API ุงุฒ ุณุณุชู ูุงฺฏ ูุนู (`utils.logger`) ุงุณุชูุงุฏู ุดูุฏ.
  - ุฏุฑ ุตูุฑุช ุงุถุงูู ฺฉุฑุฏู Sentry/Prometheus (ูุทุงุจู `IMPROVEMENTS_GUIDE.md`)ุ
    - ุฎุทุงูุง ููโุงูพ ูู ุจู ุขู ฺฏุฒุงุฑุด ุดููุฏ.

ุงู ุณูุฏ ฺุงุฑฺูุจ ฺฉู ุชุณุช ู ุงุนุชุจุงุฑุณูุฌ ุฑุง ูุดุฎุต ูโฺฉูุฏุ ุฌุฒุฆุงุช ุฏูู ูพุงุฏูโุณุงุฒ ุชุณุชโูุง ุจู ุณุงุฎุชุงุฑ ููุง API ู Frontend ุจุณุชฺฏ ุฎูุงูุฏ ุฏุงุดุช.
