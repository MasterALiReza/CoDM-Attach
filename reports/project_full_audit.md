# Project Audit Report โ CODM Attachments Bot (`codm-bot-modular`)

ุชุงุฑุฎ ุชููุฏ ฺฏุฒุงุฑุด: 2025-11-16  
ูุณุฎู ฺฉุฏ ุจุฑุฑุณโุดุฏู ุจุฑ ุงุณุงุณ ูุถุนุช ูุนู ุฑูพู ุฏุฑ ุฒูุงู ุงุฌุฑุง

---

## 1. ุฎูุงุตูโ ุงุฌุฑุง

- **ูุถุนุช ฺฉู**: ฺฉุฏ ุงุฒ ูุธุฑ ูุนูุงุฑ (Modular/Registry/Adapter)ุ ูุงู ุฏุชุงุจุณ (PostgreSQL + Pooling + FTS)ุ i18nุ ู ูุงฺฏูฺฏ ุณุงุฎุชุงุฑ ุจุงูุบ ุฏุงุฑุฏ.
- **ุจุฒุฑฺฏโุชุฑู ุฑุณฺฉโูุง**:
  - **ุงูฺฏู ฺฏุณุชุฑุฏูโ `bare except` ู `except: pass`** ุฏุฑ ููุฏูุฑูุง ู ููุฌุฑูุง ฺฉู ุฎุทุงูุง ุฑุง ูพููุงู ูโฺฉูุฏ.
  - **ฺฏุช ุนุถูุช ฺฉุงูุงู ุงุฌุจุงุฑ** ฺฉู ุฏุฑ ุจุฑุฎ ุณูุงุฑููุง **fail-open** ุนูู ูโฺฉูุฏ (ุฏุฑ ุตูุฑุช ูุจูุฏ DB ุฏุฑ ฺฉุงูุชฺฉุณุช ุง ุจุฑุฎ ุฎุทุงูุง).
  - **ุนุฏู ุงุณุชูุงุฏูโ ฺฉุงูู ุงุฒ i18n ุฏุฑ ููุชูฺฉุดูโูุง** (ูุชูโูุง ูุงุฑุณ hard-coded ุฏุฑ `config` ุจุฑุง ููู ุฒุจุงูโูุง).
  - **ูพูุดุด ุชุณุช ูุญุฏูุฏ ุจุฑุง ูุงฺููโูุง core (User Handlers, Managers)** ู ุชูุฑฺฉุฒ ุชุณุชโูุง ุฑู ฺูุฏ Helper.
- **ุชูุตูโ ฺฉูุงู**: ุฏุฑ ูุงุฒ ุจุนุฏ ุชูุณุนูุ ุชูุฑฺฉุฒ ุฑู **ฺฉุณุงูโุณุงุฒ ุงูฺฏู error handling + i18n** ู **ุงูุฒุงุด ูพูุดุด ุชุณุช ูุงุญุฏ** ุจุดุชุฑู ุจุงุฒฺฏุดุช ุณุฑูุงู ุฑุง ุฎูุงูุฏ ุฏุงุดุช.

---

## 2. ุฑุงูููุง ู ุฏุณุชูโุจูุฏ

### 2.1. ุณุทูุญ ุงููุช (Severity)

- **Critical**: ูโุชูุงูุฏ ุจู ุงุฒ ุฏุณุช ุฑูุชู ุฏุงุฏูุ crash ุฏุฑ ุณูุงุฑููุง ุฑุงุฌุ ุง ููุถ ุฌุฏ ุฑูุชุงุฑ/ุณุงุณุช ููุฌุฑ ุดูุฏ.
- **Major**: ุฑุณฺฉ ุจุฑูุฒ ุจุงฺฏโูุง ุณุฎุชู ุฏุจุงฺฏุ ูุงููุงููฺฏ UXุ ุง ุฑูุชุงุฑ ุฎูุงู ุงูุชุธุงุฑ ุฏุฑ ุดุฑุงุท ุฎุงุต ุฑุง ุงุฌุงุฏ ูโฺฉูุฏ.
- **Minor**: ูุดฺฉูุงุช ฺฉูฺฺฉุ ุชฺฉูฺฉ ุง UX ฺฉู ุจุดุชุฑ ุจู ฺฉูุช ู ูฺฏูโุฏุงุฑ ูุฑุจูุท ุงุณุช.

### 2.2. ููุน ูุดฺฉู (Type)

- **Bug** โ ุฑูุชุงุฑ ูุงุฏุฑุณุช ุง ูพุชุงูุณู ุฎุทุง ููุทู.
- **Architecture** โ ุทุฑุงุญ ุง ุฌุฏุงุณุงุฒ ูุงูโูุง ฺฉู ุฏุฑ ุขูุฏู ูุดฺฉูโุณุงุฒ ูโุดูุฏ.
- **Security/Business Logic** โ ุฑุณฺฉ ุงููุช ุง ููุถ ูุงููู ฺฉุณุจโูฺฉุงุฑ.
- **Reliability/Error Handling** โ ูุฏุฑุช ุฎุทุงุ ูพุงุฏุงุฑ ู observability.
- **Performance** โ ฺฉุงุฑุง ู ูุตุฑู ููุงุจุน.
- **i18n/UX** โ ุจูโุงููููโุณุงุฒุ ุชุฌุฑุจู ฺฉุงุฑุจุฑ ู ูุชูโูุง.
- **Testing/Maintainability** โ ุชุณุชโูพุฐุฑ ู ูฺฏูโุฏุงุฑ.

ุจุฑุง ูุฑ ูุดฺฉู:  
**ุนููุงูุ ูุญู ุฏููุ ุชูุถุญุ ุชุงุซุฑุ ุดุฏุชุ ููุนุ ูพุดููุงุฏุ ู ููููู ฺฉุฏ** ุงุฑุงุฆู ุดุฏู ุงุณุช.

---

## 3. ูุดฺฉูุงุช Critical

### C1 โ ุงุณุชูุงุฏูโ ฺฏุณุชุฑุฏู ุงุฒ `bare except` ู `except: pass` ุฏุฑ ูุณุฑูุง runtime

- **Type**: Reliability/Error Handling, Maintainability  
- **Severity**: Critical

#### ูุญูโูุง ฺฉูุฏ

- **`handlers/user/user_handlers_aggregator.py`**
  - ูุชุฏ `download_all_attachments` (ุชูุฑุจุงู ุฎุทูุท 579โ595)
    - ููููู:

      ```python
      payload = query.data.replace("download_all_br_", "").replace("download_all_mp_", "")
      mode = 'br' if 'download_all_br_' in query.data else 'mp'
      try:
          category, weapon_name = payload.split("__", 1)
      except:
          lang = get_user_lang(update, context, self.db) or 'fa'
          await query.edit_message_text(t('error.generic', lang))
          return
      ```

  - ูุชุฏ `send_attachment_quick` (ุชูุฑุจุงู ุฎุทูุท 525โ534)

- **`handlers/user/modules/attachments/all_handler.py`**

  - ูุชุฏ `attachment_detail_with_mode` (ุฎุทูุท 282โ288):

    ```python
    payload = query.data.replace("attm_", "")
    try:
        mode, code = payload.split("_", 1)
    except:
        lang = get_user_lang(update, context, self.db) or 'fa'
        await safe_edit_message_text(query, t('error.generic', lang))
        return
    ```

- **`managers/backup_manager.py`**

  - ูุชุฏ `export_to_json` (ุฎุทูุท 330โ335):

    ```python
    try:
        users = self.db.get_all_users()
        export_data["data"]["users"] = users
    except:
        pass
    ```

- ุนูุงูู ุจุฑ ุงู ูููููโูุงุ ุฌุณุชุฌู ุฑู ฺฉู ูพุฑูฺู ูุดุงู ูโุฏูุฏ ุชุนุฏุงุฏ ูุงุจูโุชูุฌู `except:` ุจุฏูู ููุน ุงุณุช (ูู ุฏุฑ ููุฏูุฑูุง ุงุฏููุ ูู ฺฉุงูุงูุ ูู ูุงฺููโูุง ุฏฺฏุฑ).

#### ุชูุถุญ ู ุชุงุซุฑ

- `bare except` ูููโฺุฒ (ุญุช `SystemExit`, `KeyboardInterrupt`) ุฑุง ูโฺฏุฑุฏ ู ุงุฌุงุฒู ูโุฏูุฏ **ุจุงฺฏโูุง ูุงูุน ุจุฏูู ูุงฺฏ ู ุจุฏูู ุงุทูุงุน** ุฑุฏ ุดููุฏ.
- ุฏุฑ ูุซุงู `backup_manager`, ุฎุทุง ุฏุฑ `get_all_users()` **ฺฉุงููุงู ูุงุฏุฏู** ฺฏุฑูุชู ูโุดูุฏุ ุจูุงุจุฑุงู ููฺฉู ุงุณุช export ูุงูุต ุชููุฏ ุดูุฏุ ุจุฏูู ุงูฺฉู ุงูพุฑุงุชูุฑ ุงุทูุงุน ุฏุงุดุชู ุจุงุดุฏ.
- ุฏุฑ ููุฏูุฑูุง ฺฉุงุฑุจุฑุ ุฎุทุงูุง parsing callback (ฺฉู ุงุบูุจ ูุดุงููโ mismatch ุจู UI ู handler ุงุณุช) ููุท ุจู ฺฉ ูพุงู ฺฉู ยซุฎุทุง ุนูููยป ุชุจุฏู ูโุดููุฏุ ุจุฏูู ูุงฺฏ ฺฉุงู.

#### ูพุดููุงุฏ

- **ูุงุนุฏูโ ฺฉู**:
  - ุงุฒ `except:` ุงุณุชูุงุฏู ูุดูุฏุ ุฏุฑ ุตูุฑุช ูุงุฒ ุญุฏุงฺฉุซุฑ `except Exception as e:` ุฏุฑ ูุงูโูุง gateway (ูุงููุฏ entry points ุง scheduler loop) ู ููุฑุงู ุจุง **ูุงฺฏ ฺฉุฑุฏู ฺฉุงูู context** ู **re-raise ุง wrap**.
- ุจุฑุง ูุฑ ููุฑุฏ:
  - `download_all_attachments`, `attachment_detail_with_mode`, `send_attachment_quick`:
    - `ValueError` ุฑุง ุฌุฏุงฺฏุงูู ุจฺฏุฑุฏุ callback invalid ุฑุง ุจุง ูุงฺฏ ููุงุณุจ ุซุจุช ฺฉูุฏ ู ูพุงู ฺฉุงุฑุจุฑูพุณูุฏ ุจุฏูุฏ.
  - `export_to_json`:
    - ุจูโุฌุง `except: pass` ุญุฏุงูู `except Exception as e:` + `logger.error` ู ุดุงุฏ ุงูุฒูุฏู ููฺฏ ุง ููุฏ `"users_exported": false` ุฏุฑ metadata.
- ฺฉ **ุฌุณุชุฌู ุณุณุชูุงุชฺฉ** ุฑู `except:` ุงูุฌุงู ุดูุฏ ู ุชูุงู ููุงุฑุฏ ุจู ุตูุฑุช case-by-case ุงุตูุงุญ ฺฏุฑุฏุฏ.

---

## 4. ูุดฺฉูุงุช Major

### M1 โ ฺฏุช ุนุถูุช ฺฉุงูุงู ุงุฌุจุงุฑ ุฏุฑ ุจุฑุฎ ุณูุงุฑููุง fail-open ุงุณุช

- **Type**: Security/Business Logic, Reliability  
- **Severity**: Major

#### ูุญู

- **`managers/channel_manager.py`**
  - ุฏฺฉูุฑุชูุฑ `require_channel_membership`ุ ุฎุทูุท ุญุฏูุฏ 304โ312:

    ```python
    db = context.bot_data.get('database')
    if not db:
        logger.error("Database not found in bot_data")
        if update_or_context is None:
            return await func(update, context, *args, **kwargs)
        else:
            return await func(self, update, context, *args, **kwargs)
    ```

  - ูุชุฏ `_check_single_channel`ุ ุฎุทูุท 138โ145:

    ```python
    except Exception as e:
        ...
        if "ConnectError" in error_type or "NetworkError" in error_type or "TimedOut" in error_type:
            return True, channel  # ุฏุฑ ุตูุฑุช ุฎุทุง ุดุจฺฉูุ ูุฑุถ ฺฉู ุนุถู ุงุณุช
        else:
            return False, channel
    ```

#### ุชูุถุญ ู ุชุงุซุฑ

- ุงฺฏุฑ ุจู ูุฑ ุฏูู `database` ุฏุฑ `context.bot_data` ุณุช ูุดุฏู ุจุงุดุฏุ ฺฏุช ุนุถูุช **ฺฉุงููุงู ุบุฑูุนุงู** ูโุดูุฏ ู ููุฏูุฑ ุจุฏูู ูฺ ูุญุฏูุฏุช ฺฉุงูุงู ุงุฏุงูู ูโุงุจุฏ.
- ุฏุฑ ุตูุฑุช ุจุฑูุฒ ุฎุทุง ุดุจฺฉู ููฺฏุงู ูุฑุงุฎูุงู `get_chat_member`ุ ฺฉุงุฑุจุฑ **ุจูโุตูุฑุช ูพุดโูุฑุถ ุนุถู ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดูุฏ** (fail-open). ุงู ุฑูุชุงุฑ ููฺฉู ุงุณุช ุงุฒ ูุธุฑ ฺฉุณุจโูฺฉุงุฑ (ฺฉุงูุงูโูุง ุงุฌุจุงุฑ) ูุงุจู ูุจูู ูุจุงุดุฏ.

#### ูพุดููุงุฏ

- ุจุฑุง ูุจูุฏู DB ุฏุฑ `bot_data`:
  - ุจูโุฌุง ุงุฏุงูู ุฏุงุฏูุ ุง **ุฎุทุง ูุงุถุญ ุจุฑุง ุงุฏูู** ุงุฑุณุงู ุดูุฏุ ุง bot ุฏุฑ ุขู ูุณุฑ **ุจูโุตูุฑุช fail-closed** ุนูู ฺฉูุฏ (ูุซูุงู ูพุงู ุฎุทุง ุจู ฺฉุงุฑุจุฑ + ุนุฏู ุงุฌุฑุง ูุฑูุงู ุงุตู).
- ุจุฑุง ุฎุทุงูุง ุดุจฺฉู:
  - ุจุณุชู ุจู ุณุงุณุชุ ูโุชูุงู ฺฉ **ูพุงู ยซุฎุทุง ุดุจฺฉูุ ูุทูุงู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏยป** ูุดุงู ุฏุงุฏ ู ุงุฌุงุฒูโ ุนุจูุฑ ูุฏุงุฏ.
  - ุงฺฏุฑ fail-open ูุงุฒู ุงุณุชุ ุญุฏุงูู ุงู ุฑูุชุงุฑ ุจุง **ุชูุธูุงุช ูุงุจูโูพฺฉุฑุจูุฏ** ุดูุฏ (ูุซูุงู `CHANNEL_FAIL_OPEN_ON_NETWORK_ERROR` ุฏุฑ `.env`).

---

### M2 โ ุชุฑุฌุญุงุช ููุชูฺฉุดู ฺฉุงุฑุจุฑุงู ุฏุฑ ุตูุฑุช ุฎุทุง fail-open ูโุดูุฏ

- **Type**: Reliability, UX/Privacy  
- **Severity**: Major

#### ูุญู

- **`managers/notification_manager.py`**ุ ูุชุฏ `_get_active_users_for_events` (ุฎุทูุท 258โ262):

  ```python
  except Exception as e:
      logger.error(f"Error checking user {user_id} preferences: {e}")
      log_exception(logger, e, "context")
      # ุฏุฑ ุตูุฑุช ุฎุทุงุ ูพุดโูุฑุถ ุงุฑุณุงู ฺฉู
      active_users.add(user_id)
  ```

#### ุชูุถุญ ู ุชุงุซุฑ

- ูุฑ ุฎุทุง ุฏุฑ ุฎูุงูุฏู ุชูุธูุงุช ููุชู ฺฉุงุฑุจุฑ (ูุซูุงู schema mismatchุ ูุดฺฉู DB) ุจุงุนุซ ูโุดูุฏ ฺฉุงุฑุจุฑ **ุจูโุตูุฑุช ูพุดโูุฑุถ ุฏุฑ ูุณุช ุฏุฑุงูุชโฺฉููุฏฺฏุงู ูุฑุงุฑ ฺฏุฑุฏ**ุ ุญุช ุงฺฏุฑ ุฏุฑ ฺฏุฐุดุชู ุงุนูุงูโูุง ุฑุง ุบุฑูุนุงู ฺฉุฑุฏู ุจุงุดุฏ.
- ุงู ุฑูุชุงุฑ ูโุชูุงูุฏ ุจู **ุงุฑุณุงู ุงุนูุงู ูุงุฎูุงุณุชู** ู ุฏุฑ ููุงุฑุฏ ูุดฺฉู ุญุฑูโุฎุตูุต ููุฌุฑ ุดูุฏ.

#### ูพุดููุงุฏ

- ุฏุฑ ุตูุฑุช ุฎุทุงุ ุจูุชุฑ ุงุณุช **ฺฉุงุฑุจุฑ ุจูโุตูุฑุช fail-closed** ุฏุฑ ูุธุฑ ฺฏุฑูุชู ุดูุฏ (ุงุฑุณุงู ูุดุฏู ุงุนูุงู) ู ููุท ุฏุฑ ูุงฺฏโูุง ุฎุทุง ุซุจุช ุดูุฏ.
- ุงูฺฉุงู ุงุถุงูู ฺฉุฑุฏู **ูุชุฑฺฉ/ูุงฺฏ ูุฌุฒุง** ุจุฑุง ุชุนุฏุงุฏ ฺฉุงุฑุจุฑุงู ฺฉู ุจู ุฏูู ุฎุทุง ุงุฒ ุงุฑุณุงู ุฎุงุฑุฌ ุดุฏูโุงูุฏ.

---

### M3 โ ููุชูฺฉุดูโูุง ุงุชฺููุช (NOTIFICATION_SETTINGS) i18n ูุดุฏู ู ููุท ูุงุฑุณ ูุณุชูุฏ

- **Type**: i18n/UX  
- **Severity**: Major

#### ูุญู

- **`config/config.py`**ุ ุฏฺฉุดูุฑ `NOTIFICATION_SETTINGS`ุ ุชูุฑุจุง ุฎุทูุท 297โ321:

  ```python
  NOTIFICATION_SETTINGS = {
      "enabled": True,
      "events": {
          "add_attachment": True,
          ...
      },
      "templates": {
          "add_attachment": "๐ ุงุชฺููุช {mode_name} ุฌุฏุฏ ุจุฑุง {weapon} ุงุถุงูู ุดุฏ: {name} ({code})",
          "edit_name": "โ๏ธ ูุงู ุงุชฺููุช {mode_name} ุงุฒ ยซ{old_name}ยป ุจู ยซ{new_name}ยป ุจุฑุง {weapon} ุชุบุฑ ฺฉุฑุฏ.",
          ...
      },
      "auto_notify": True
  }
  ```

- **`managers/notification_manager.py`**ุ ูุชุฏ `_build_combined_message` (ุฎุทูุท 140โ155) ุงู template ูุง ุฑุง ุจุฑุง ุชฺฉโุฑูุฏุงุฏ ุงุณุชูุงุฏู ูโฺฉูุฏ.

#### ุชูุถุญ ู ุชุงุซุฑ

- ุญุช ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฒุจุงู ุงูฺฏูุณ ุฏุงุดุชู ุจุงุดุฏุ ูุชู ููุชูฺฉุดูโูุง ุงุฒ ุงู templates ูุงุฑุณ ุชููุฏ ูโุดูุฏุ ููุท `mode_name` ู ูุงู ุฏุณุชู ุจุง i18n ููุงููฺฏ ุงุณุช.
- ุงู ููุถูุน ุจุงุนุซ **ุชุฌุฑุจู ฺฉุงุฑุจุฑ ูุงุณุงุฒฺฏุงุฑ** (ููููุง ู ูพุงูโูุง ุงูฺฏูุณุ ุงุนูุงูโูุง ูุงุฑุณ) ูโุดูุฏ.

#### ูพุดููุงุฏ

- ุงูุชูุงู `NOTIFICATION_SETTINGS['templates']` ุจู ุณุณุชู i18n:
  - ุชุนุฑู ฺฉูุฏูุง ูุงููุฏ `notification.attachment.add`, `notification.attachment.edit_name`, ... ุฏุฑ `locales/fa.json` ู `locales/en.json`.
  - ุงุณุชูุงุฏู ุงุฒ `t()` ุจุฑุง ุชููุฏ ูุชู ู ููุท ูฺฏู ุฏุงุดุชู ุชูุธูุงุช ููุทู (enabled events, auto_notify) ุฏุฑ `config`.

---

### M4 โ ูุชูโูุง legacy ุฏุฑ `config.MESSAGES` ู ฺูุฏ import ุจูุงุงุณุชูุงุฏู

- **Type**: i18n/UX, Maintainability  
- **Severity**: Major

#### ูุญู

- **`config/config.py`**ุ ุฏฺฉุดูุฑ `MESSAGES` (ุฎุทูุท 325โ374)ุ ุชูุงูุง ูุชูโูุง ูุงุฑุณ.
- **`managers/channel_manager.py`**ุ ุชุงุจุน `_send_main_menu` (ุฎุทูุท 387โ447):

  ```python
  from config import MESSAGES  # import ุงูุง ุฏุฑ ุงุฏุงูู ุงุฒ t() ุงุณุชูุงุฏู ูโุดูุฏ
  ...
  welcome_text = t("welcome", lang, app_name=t("app.name", lang))
  ```

#### ุชูุถุญ ู ุชุงุซุฑ

- `MESSAGES` ูุฌููุนูโุง ุงุฒ ูพุงูโูุง ูุงุฑุณ ุงุณุช ฺฉู ุงฺฉููู ุนููุงู ุชูุณุท i18n ุฌุงฺฏุฒู ุดุฏูโุงูุฏุ ุงูุง ูููุฒ ุฏุฑ ฺฉุฏ ุญุถูุฑ ุฏุงุฑูุฏ.
- ุงู ูุถุนุช ููุจุน ุญููุช ุจุฑุง ูุชูโูุง ุฑุง ุฏูฺฏุงูู ูโฺฉูุฏ (ุจุฎุด ุฏุฑ i18nุ ุจุฎุด ุฏุฑ config) ู ุฏุฑ ุตูุฑุช ุงุณุชูุงุฏูโ ุงุชูุงู ุงุฒ `MESSAGES`ุ ุจุงุนุซ ูุงุณุงุฒฺฏุงุฑ ุฒุจุงู ูโุดูุฏ.

#### ูพุดููุงุฏ

- ุดูุงุณุง ุชูุงู ุฌุงูุง ฺฉู `MESSAGES` ุงุณุชูุงุฏู ูโุดูุฏ (ุงฺฏุฑ ูููุฒ ุฌุง ูุตุฑู ูโุดูุฏ) ู ุจู `t()` ููุงุฌุฑุช ุฏุงุฏู.
- ุฏุฑ ุตูุฑุช ุนุฏู ุงุณุชูุงุฏูโ ูุงูุนุ **ุนูุงูุชโฺฏุฐุงุฑ ุจูโุนููุงู legacy** (ูุซูุงู ุฏุฑ ฺฉ ุจุฎุด ุฌุฏุงฺฏุงูู ุง ุจุง ฺฉุงููุช ูุงุถุญ) ุง ุงูุชูุงู ุจู `archive/legacy`.

---

### M5 โ ุฑูุชุงุฑ ูพุดุชุจุงูโฺฏุฑ (Backup) ู Import JSON ุจุฏูู ุงุณุชูุงุฏูโ ูุงูุน ุงุฒ ููฺฏ `merge`

- **Type**: Reliability, Architecture  
- **Severity**: Major

#### ูุญู

- **`managers/backup_manager.py`**
  - ูุชุฏ `restore_from_backup` (ุฎุทูุท 243โ266) ู `import_from_json` (ุฎุทูุท 404โ508)ุ ุงูุถุง:

    ```python
    def import_from_json(self, import_file: str, merge: bool = False) -> bool:
    ```

  - ูพุงุฑุงูุชุฑ `merge` ุฏุฑ ุจุฏููโ ุชุงุจุน ุงุตูุงู ุงุณุชูุงุฏู ูุดุฏู ุงุณุช.

#### ุชูุถุญ ู ุชุงุซุฑ

- ุงุฒ ุงูุถุง ุชุงุจุน ุงูุชุธุงุฑ ูโุฑูุฏ ุฑูุชุงุฑ ยซmergeยป ู ยซoverwriteยป ูุงุจู ุชูุธู ุจุงุดุฏุ ุงูุง ูุนูุงู ูุฑ ุฏู ุญุงูุช ฺฉ ุงุณุช.
- ุงู ููุถูุน ูโุชูุงูุฏ ุจุฑุง ุงุฏูู ฺฏูุฑุงูโฺฉููุฏู ุจุงุดุฏ ู ุฏุฑ ุขูุฏู ุฏุฑ ุตูุฑุช ุงุถุงูู ุดุฏู branchูุง ุฌุฏุฏุ ุจู **ุฑูุชุงุฑ ูุงุณุงุฒฺฏุงุฑ** ููุฌุฑ ุดูุฏ.

#### ูพุดููุงุฏ

- ุง:
  - ูพุงุฑุงูุชุฑ `merge` ุฑุง ุญุฐู ฺฉุฑุฏู ู ุฑูุชุงุฑ ูุนู ุฑุง ุจูโูุถูุญ ุฏุฑ docstring ูุณุชูุฏ ฺฉูุฏ.
- ุง (ูพุดููุงุฏ ุจูุชุฑ):
  - ุฏู ูุณุฑ ูุงุถุญ ูพุงุฏูโุณุงุฒ ุดูุฏ:
    - `merge=True`: ููุท ุงุถุงูู/ุขูพุฏุช ุฑฺฉูุฑุฏูุง ุจุฏูู ุญุฐู.
    - `merge=False`: ุงุจุชุฏุง ูพุงฺฉโุณุงุฒ ูุญุฏูุฏู ุชฺฉูู (ูุซูุงู ฺฉ ุฏุณุชู/ุณูุงุญ)ุ ุณูพุณ import.

---

## 5. ูุดฺฉูุงุช Minor

### m1 โ ุงุณุชูุงุฏู ุงุฒ `print()` ู `sys.exit()` ุฏุฑ ูุงฺูู `config`

- **Type**: Reliability, Observability  
- **Severity**: Minor

#### ูุญู

- **`config/config.py`**:

  ```python
  if not BOT_TOKEN:
      print("โ ุฎุทุง: ุชูฺฉู ุฑุจุงุช ุงูุช ูุดุฏ!")
      print("ูุทูุงู ูุงู .env ุฑุง ุงุฌุงุฏ ฺฉุฑุฏู ู BOT_TOKEN ุฑุง ุชูุธู ฺฉูุฏ.")
      print("ูโุชูุงูุฏ ุงุฒ .env.example ุจู ุนููุงู ููููู ุงุณุชูุงุฏู ฺฉูุฏ.")
      sys.exit(1)
  ...
  except ValueError:
      print("โ๏ธ ุฎุทุง: SUPER_ADMIN_ID ุจุงุฏ ฺฉ ุนุฏุฏ ูุนุชุจุฑ ุจุงุดุฏ")
  ...
  else:
      print("โ๏ธ ุชูุฌู: SUPER_ADMIN_ID ุชูุธู ูุดุฏู. ุฑุจุงุช ุจุฏูู ุงุฏูู ุดุฑูุน ูโุดูุฏ.")
  ```

#### ุชูุถุญ ู ุชุงุซุฑ

- ุฏุฑ ูุญุทโูุง production ู Dockerุ ุงุณุชูุงุฏู ุงุฒ `print` ุจูโุฌุง logger ุจุงุนุซ ุงุฒ ุฏุณุช ุฑูุชู context ู ุณุงุฎุชุงุฑ ูุงฺฏ ูโุดูุฏ.
- `sys.exit(1)` ุฏุฑ import-time ูโุชูุงูุฏ ุงุฌุฑุง ุชุณุชโูุง/ุงุณฺฉุฑูพุชโูุง ุฑุง ุณุฎุช ฺฉูุฏ (ูุซูุงู ููฺฏุงู import ูุงฺูู ุจุฑุง ุชุณุช unit ุจุฏูู ุฏุงุดุชู `.env`).

#### ูพุดููุงุฏ

- ุงุณุชูุงุฏู ุงุฒ ุณุณุชู ูุงฺฏ ููุฌูุฏ (`utils.logger`) ุจุฑุง ุซุจุช ุงู ูพุงูโูุง ู **ุจุงูุง ุจุฑุฏู ุฎุทุง ุจู caller** (ูุซูุงู ุงุฒ ุทุฑู Exception custom) ุชุง main ุชุตูู ุจฺฏุฑุฏ ฺฺฏููู ูุงฺฉูุด ูุดุงู ุฏูุฏ.

---

### m2 โ ูุงฺฏ ูุดุฏู ุจุฑุฎ ุฎุทุงูุง parsing callback ุฏุฑ ููุฏูุฑูุง

- **Type**: Debuggability, Reliability  
- **Severity**: Minor

#### ูุญู

- **`handlers/user/modules/attachments/all_handler.py`**ุ ูุชุฏ `attachment_detail_with_mode` (ุฎุทูุท 282โ288): ุฏุฑ ุตูุฑุช ุฎุทุง ุฏุฑ `payload.split`ุ ููุท ูพุงู ุนููู ุจู ฺฉุงุฑุจุฑ ุฏุงุฏู ูโุดูุฏ ู ุฎุทุง ูุงฺฏ ููโุดูุฏ.
- **`handlers/user/user_handlers_aggregator.py`**ุ ูุชุฏ `send_attachment_quick` (ุฎุทูุท 527โ534) ูุฒ ุฏุฑ ูุณุฑ fallback ุฏูู ุจุฏูู ูุงฺฏ return ูโฺฉูุฏ.

#### ุชูุถุญ ู ุชุงุซุฑ

- callback ูุง invalid ูุนูููุงู ูุดุงููโ mismatch ุจู UI ู handler ุง ุจุงฺฏ ุฏุฑ ุณุงุฎุช callback_data ูุณุชูุฏ. ูุจูุฏ ูุงฺฏุ ุฏุจุงฺฏ ุงู ููุงุฑุฏ ุฑุง ุณุฎุช ูโฺฉูุฏ.

#### ูพุดููุงุฏ

- ูุจู ุงุฒ ุงุฑุณุงู ูพุงู ฺฉุงุฑุจุฑูพุณูุฏุ ุฎุทุง ุญุฏุงูู ุจุง ุณุทุญ `warning/error` ูุงฺฏ ุดูุฏ ู ุดุงูู `query.data` ุจุงุดุฏ.

---

### m3 โ ุฑุณฺฉ ุฑุดุฏ ุญุงูุธู ุฏุฑ ุตู ููุชูฺฉุดูโูุง ุชุฑฺฉุจ ุจุฑุง ุชุนุฏุงุฏ ุฒุงุฏ ุงุชฺููุชโูุง ฺฉุชุง

- **Type**: Performance/Maintainability  
- **Severity**: Minor

#### ูุญู

- **`managers/notification_manager.py`**:
  - ุฏฺฉุดูุฑโูุง ุฏุฑููโุญุงูุธูโุง `pending_notifications` ู `_batch_tasks` ุจุฑ ุงุณุงุณ ฺฉูุฏ `category_weapon_code_mode` (ุฎุทูุท 50โ80).

#### ุชูุถุญ ู ุชุงุซุฑ

- ุฏุฑ ุญุงูุช ุนุงุฏุ ุจุนุฏ ุงุฒ `batch_delay` 3 ุซุงููโุงุ entryูุง ูพุงฺฉ ูโุดููุฏุ ุงูุง ุงฺฏุฑ ุจู ูุฑ ุฏูู `_send_batch_notification` ุงุณุชุซูุงุก ุฏุงุฆู ุจุฏูุฏ ุง taskูุง ูุบู ูุดููุฏุ ุงู ุฏฺฉุดูุฑโูุง ูโุชูุงููุฏ ุฑุดุฏ ฺฉููุฏ.

#### ูพุดููุงุฏ

- ุงูุฒูุฏู **ุญูุงุธโูุง ุซุงููู** (ูุซูุงู ูุญุฏูุฏุช ุงูุฏุงุฒู map ู ูพุงฺฉโุณุงุฒ ุฏูุฑูโุง) ู ูุงฺฏ ฺฉุฑุฏู ุชุนุฏุงุฏ ฺฉูุฏูุง ููุฌูุฏ ุจุฑุง ูุงูุชูุฑูฺฏ.

---

### m4 โ ูพูุดุด ุชุณุช ูุญุฏูุฏ ุจุฑุง core handlers ู managers

- **Type**: Testing/Maintainability  
- **Severity**: Minor

#### ูุญู

- ุณุงุฎุชุงุฑ ุชุณุชโูุง:
  - `tests/test_sql_helpers.py` ููุท `core.database.sql_helpers` ุฑุง ูพูุดุด ูโุฏูุฏ.
  - ุชุนุฏุงุฏ ุชุณุช integration ุฏุฑ `tests/integration/` (ูุงููุฏ `test_db_smoke.py`, `test_search.py`, `test_subscribers_pg.py`, ...) ูุฌูุฏ ุฏุงุฑุฏุ ุงูุง handlerูุง ฺฉุงุฑุจุฑุ `ChannelManager`, `NotificationManager`, `BackupManager` ู ูุณุฑูุง ูพฺุฏูโ callbackูุง ูพูุดุด ูุณุชูู ูุฏุงุฑูุฏ.

#### ุชูุถุญ ู ุชุงุซุฑ

- ุจุฎุด ุฒุงุฏ ุงุฒ ููุทู ูพฺุฏู (ุจูโุฎุตูุต ุฏุฑ `handlers/user` ู `managers`) ูุงูุฏ ุชุณุช ูุงุญุฏ ุงุณุชุ ูุฑ refactor ุง ุงุตูุงุญ error handling ูโุชูุงูุฏ ุจุฏูู ุชุณุช ุงุชููุงุชฺฉ regressions ุงุฌุงุฏ ฺฉูุฏ.

#### ูพุดููุงุฏ

- ุชุนุฑู ุชุณุชโูุง ูุงุญุฏ ุจุฑุง:
  - `ChannelManager.check_user_membership` ู `require_channel_membership` (ุจุง mock ฺฉุฑุฏู Telegram API ู DB).
  - `NotificationManager._build_combined_message` ุจุฑุง ุณูุงุฑููุง ุชฺฉ/ฺูุฏ ุฑูุฏุงุฏ.
  - `BackupManager.import_from_json` ู `export_to_json` ุฑู ฺฉ DB ุขุฒูุงุด.

---

## 6. ูพุดููุงุฏูุง ฺฉู (Roadmap ูู)

1. **ูพุงฺฉโุณุงุฒ ุณุณุชูุงุชฺฉ error handling**  
   - ูุณุชโฺฏุฑ `except:` ู `except Exception` ุฏุฑ ฺฉู ูพุฑูฺู ู ุชุนู ุณุงุณุช ูุงุญุฏ:
     - ููุท ุฏุฑ ูุงูโูุง ูุฑุฒ (main, scheduler, global error handler) catch ฺฉู ูุฌุงุฒ ุจุงุดุฏ.
     - ุฏุฑ handlerูุง ู ููุฌุฑูุง exceptionูุง ูุดุฎุต (ูุงููุฏ `ValueError`, `KeyError`, `psycopg.errors.*`) ูุฏุฑุช ุดููุฏ.

2. **ุชฺฉูู i18n ุจูโุฎุตูุต ุจุฑุง ููุชูฺฉุดูโูุง ู legacy messages**  
   - ุงูุชูุงู `NOTIFICATION_SETTINGS.templates` ู `MESSAGES` ุจู `locales/*.json`.
   - ฺฉุณุงูโุณุงุฒ ููุงุด mode ุจู ุงูฺฏู `mode.label + mode._short` ุฏุฑ ูููโุฌุง (ูุทุงุจู ฺฉุงุฑ ฺฉู ุฏุฑ Suggested/Guides ุงูุฌุงู ุดุฏู ุงุณุช).

3. **ุชููุช ุชุณุชโูุง**  
   - ุงูุฒูุฏู ุชุณุชโูุง ูุงุญุฏ ุจุฑุง ูุณุฑูุง critical (ฺฉุงูุงู ุงุฌุจุงุฑุ ููุชูฺฉุดูโูุงุ backup/import).
   - ุงุณุชูุงุฏู ุงุฒ pytest fixtures ุจุฑุง mock ฺฉุฑุฏู DB ู Telegram Bot.

4. **ุณุฎุชโุชุฑ ฺฉุฑุฏู ุฑูุชุงุฑ fail-open ุฏุฑ ุจุฎุดโูุง ุญุณุงุณ**  
   - ุจุฑุง ุฑุงูููุง: ุนุถูุช ฺฉุงูุงู ู ุชุฑุฌุญุงุช ููุชูฺฉุดู ุฑุง ุทูุฑ ุชูุธู ฺฉูุฏ ฺฉู ุฏุฑ ุตูุฑุช ุฎุทุงุ ุชุฑุฌุญุงู fail-closed ุจุงุดูุฏ ุง ุญุฏุงูู ุจุง ุชูุธูุงุช ูุงุจูโูพฺฉุฑุจูุฏ ฺฉูุชุฑู ุดููุฏ.

---

## 7. ุฌูุนโุจูุฏ

- ูุนูุงุฑ ูพุฑูฺูุ ูุงู ุฏุชุงุจุณ ู ุณุณุชู ูุงฺฏูฺฏ/ุงูุชฺฏุฑุดู ุจูโุตูุฑุช ฺฉู ุทุฑุงุญ ูู ู ููุนุทู ุฏุงุฑูุฏ.
- ููุงุท ุถุนู ุงุตู ุฏุฑ **ุงูฺฏููุง ูพุฑุงฺฉูุฏูโ error handling** ู **ูุงููุงููฺฏโูุง i18n** ุงุณุชุ ฺฉู ุจุง ฺูุฏ refactor ูุฏูููุฏ ูโุชูุงูุฏ ุจู ุณุทุญ production-grade ุจุณุงุฑ ูพุงุฏุงุฑ ุงุฑุชูุง ุงุจุฏ.
- ุงู ฺฏุฒุงุฑุด ุฑู ุจุฎุดโูุง ุชูุฑฺฉุฒ ฺฉุฑุฏู ฺฉู ุจุฑ ุงุณุงุณ ฺฉุฏ ูุนู ู ุฌุณุชุฌููุง ุงูุฌุงูโุดุฏูุ ุจุดุชุฑู ุฑุณฺฉ ุง ูุฒููโ ูฺฏูโุฏุงุฑ ุฑุง ุฏุงุฑูุฏุ ุฏุฑ ุตูุฑุช ูุงุฒุ ูโุชูุงู ุจุฑุง ูุฑ ุฒุฑุณุณุชู (Admin, User Attachments, Mini App) ฺฏุฒุงุฑุด ุฌุฒุฆโุชุฑ ุชูู ฺฉุฑุฏ.
