# ุฑุงูููุง ุงุตูู ุฏูโุฒุจุงููโุณุงุฒ (FA/EN) ุจุฑุง ูพุฑูฺู `codm-bot-modular`

ุงู ุณูุฏ ูุณุฎู ููโุชุฑุงุฒ ุจุง ฺฉุฏ ูุนู ูพุฑูฺู ุงุณุช ู ฺฉ ููุดูโุฑุงู ุนูู ุจุง ฺฺฉโูุณุชโูุงุ ุณุงุฎุชุงุฑ ูุงูโูุงุ ุชุฒุฑู i18n ุฏุฑ ููุงุท ฺฉูุฏ (ูุจู ุงุฒ ฺฏุช ุนุถูุช ฺฉุงูุงู)ุ ููุงุฌุฑุช ุฏุชุงุจุณุ ุชูุธูุงุชุ ุชุณุชโูุง ู ุงูุชุดุงุฑ ุชุฏุฑุฌ ุงุฑุงุฆู ูโุฏูุฏ. ูุฏู: ุงูุฒูุฏู ูุงุฑุณ ู ุงูฺฏูุณ ุจุฏูู ุงุฎุชูุงู ุฏุฑ ุฌุฑุงูโูุง ููุฌูุฏ ู ุจุง ุงูฺฉุงู ุจุงุฒฺฏุดุช ุณุฑุน.

---

## ูุถุนุช ูุนู ูพุฑูฺู ู ููโุชุฑุงุฒ

- **[ฺฏุช ุนุถูุช]** ุฏฺฉูุฑุชูุฑ `require_channel_membership` ุฏุฑ `managers/channel_manager.py` ูุนุงู ุงุณุช ู ูุจู ุงุฒ ุงุฌุฑุง ุงฺฉุซุฑ ููุฏูุฑูุง ุนุถูุช ุฑุง ุจุฑุฑุณ ูโฺฉูุฏ. ูพุงูโูุง ุนุถูุช ุจุง `parse_mode='HTML'` ุงุฑุณุงู ูโุดููุฏ ู ูุนูุงู ูุงุฑุณ ูุณุชูุฏ. ุฏู ูุชุฏ ุณุงุฎุช ูพุงู/ฺฉุจูุฑุฏ:
  - `ChannelManager.create_membership_message(channels, is_first_time: bool)`
  - `ChannelManager.create_join_keyboard(channels)`
  - ูุฑ ุฏู ูุนูุงู ูพุงุฑุงูุชุฑ ุฒุจุงู ูุฏุงุฑูุฏ ู ุจุงุฏ ุจุฑุง i18n ฺฏุณุชุฑุด ุงุจูุฏ.

- **[ูพุงูโูุง ูุฑฺฉุฒ]** ุฏฺฉุดูุฑ `MESSAGES` ุฏุฑ `config/config.py` ููุจุน ุงุตู ูุชูโูุง ูุงุฑุณ ุงุณุช (ูุซูุงู `MESSAGES["welcome"]`) ู ุงุบูุจ ุจุง `parse_mode='Markdown'` ูุตุฑู ูโุดูุฏ.

- **[ููููุง]**
  - Reply Keyboard: `handlers/user/modules/navigation/main_menu.py` โ ูุชุฏ `MainMenuHandler.start()` ุจุง ุจุฑฺุณุจโูุง ูุงุฑุณ.
  - Inline Keyboard: `handlers/user/user_handlers_aggregator.py` โ ูุชุฏ `main_menu()` ุจุง ุฏฺฉููโูุง Inline ูุงุฑุณ.

- **[Regexูุง ูุนู Reply]** `app/registry/user_registry.py` ุงุฒ `filters.Regex('^...$')` ุจุง ูุชู ูุงุฑุณ ุงุณุชูุงุฏู ูโฺฉูุฏ. ุฏุฑ ุงูุชูุง ูุงู ฺฉ ุงุณุชุซูุง Regex ุจุง ยซโ๏ธ ุชูุธูุงุช ุจุงุฒยป ุฏุฏู ูโุดูุฏุ ุฏุฑ ุญุงูโฺฉู ููู ุงุตู ยซโ๏ธ ุชูุธูุงุช ฺฉุงูุงูยป ุฏุงุฑุฏ. ุจุงุฏ ฺฉุณุงูโุณุงุฒ ุง ูพุดุชุจุงู ุฏูฺฏุงูู ุงูุฌุงู ุดูุฏ.

- **[ฺฉุงูุงูโูุง ุฏุฑ DB]** ูุชุฏูุง `get_required_channels()` ู `get_active_channels()` ุฏุฑ ูุงู PostgreSQL ููุฌูุฏ ู ููุฑุฏ ุงุณุชูุงุฏูโุงูุฏ.

- **[Settings/Language]** ูุณุฑ `handlers/user/modules/settings/` ููุท `__init__.py` ุฏุงุฑุฏุ ูุงฺูู ุชูุธูุงุช ุฒุจุงู ูููุฒ ูพุงุฏู ูุดุฏู ุงุณุช.

---

## ุงูุฏุงู ู ุฏุงููู

- **[ุงูุฏุงู]**
  - ููุงุด ุงูุชุฎุงุจ ุฒุจุงู ุฏุฑ ุงููู `/start` ูุจู ุงุฒ ฺฏุช ุนุถูุช.
  - ูุญูโุณุงุฒ ูพุงูโูุง ุนุถูุช ู ููููุง ุจุฑ ุงุณุงุณ ุฒุจุงู ฺฉุงุฑุจุฑ.
  - ุงูุฒูุฏู ุจุฎุด ุชูุธูุงุช ฺฉุงุฑุจุฑ ุจุฑุง ุชุบุฑ ุฒุจุงู ุฏุฑ ูุฑ ุฒูุงู.
  - ุญูุธ ุณุงุฒฺฏุงุฑ ุจุง `MESSAGES` ู ุฌููฺฏุฑ ุงุฒ ุฑฺฏุฑุณูู.

- **[ุฎุฑูุฌโูุง]**
  - `locales/fa.json`, `locales/en.json`
  - `utils/i18n.py`, `utils/language.py`
  - ูุชุฏูุง ุฌุฏุฏ DB: `get_user_language`, `set_user_language`
  - ุชุฒุฑู i18n ุฏุฑ `managers/channel_manager.py` ู ููู ุงุตู (Reply/Inline)
  - ูุงฺูู ุชูุธูุงุช ุฒุจุงู ฺฉุงุฑุจุฑ
  - ุงุณฺฉุฑูพุช ููุงุฌุฑุช ุฏุชุงุจุณ

---

## ูุนูุงุฑ i18n ู Fallback ุงูู

- **[ฺฉุงุชุงููฺฏ ูพุงูโูุง]**
  - ูุณุฑ: `locales/`
  - ูุงูโูุง: `fa.json`, `en.json`
  - ุณุงุฎุชุงุฑ: ฺฉูุฏูุง ุซุงุจุช ู ุชูุตูุ ุฌุฏุง ุงุฒ ูุชูโูุง UI ูุนูุ ุงูุง ุจุฑุง ุณุงุฒฺฏุงุฑุ ฺฉูุฏูุง ุจุง `MESSAGES` ููโูพูุดุงู ุชุนุฑู ุดููุฏ.

- **[ูุงฺูู ุชุฑุฌูู]** `utils/i18n.py`
  - `t(key, lang, **kwargs)`: ุงุจุชุฏุง ุงุฒ ฺฉุงุชุงููฺฏโูุง ูโุฎูุงูุฏุ ุฏุฑ ุตูุฑุช ูุจูุฏ ฺฉูุฏ ุง ุบุฑูุนุงู ุจูุฏู i18n โ fallback ุจู `config.config.MESSAGES.get(key, key)`.
  - `kb(key, lang)`: ุตุฑูุงู alias ุจุฑุง ุจุฑฺุณุจ ุฏฺฉููโูุง.

- **[ูุฏุฑุช ุฒุจุงู ฺฉุงุฑุจุฑ]** `utils/language.py`
  - `get_user_lang(update, context, db)`: ุงุจุชุฏุง `context.user_data["_lang"]`ุ ุณูพุณ DB.
  - `ensure_language(update, context, db)`: ุงฺฏุฑ ุฒุจุงู ูุงูุดุฎุต ุจูุฏุ ูพุงู ุงูุชุฎุงุจ ุฒุจุงู (ุฏูโุฒุจุงูู) ุงุฑุณุงู ู ุฌุฑุงู ูุชููู ุดูุฏ.

- **[ููุจุน ุญููุช]**
  - ูพุฑุงูุฑ: `users.language` ุฏุฑ DB.
  - ฺฉุด: `context.user_data["_lang"]` ุจุฑุง ฺฉุงูุด hit ุจู DB.

---

## ุจุฑฺุณุจโูุง ุฏูู ููู ู Regex ูุนู

- **[Reply Keyboard]** ุจุฑ ุงุณุงุณ `MainMenuHandler.start()` ุฏุฑ `handlers/user/modules/navigation/main_menu.py`:
  - ยซโ๏ธ ุชูุธูุงุช ฺฉุงูุงูยป, ยซ๐ซ ุฏุฑุงูุช ุงุชฺููุชยป
  - ยซ๐ฎ ุงุชฺููุช ฺฉุงุฑุจุฑุงูยป, ยซ๐ก ุงุชฺููุชโูุง ูพุดููุงุฏยป (ุงฺฏุฑ UA ูุนุงู ุจุงุดุฏ)
  - ยซ๐ ูุณุช ุจุฑุชุฑูุงยป, ยซโญ ุจุฑุชุฑูุง ูุตูยป
  - ยซ๐ ุชูุธูุงุช ุงุนูุงูโูุงยป, ยซ๐ ุฌุณุชุฌู ุงุชฺููุชยป
  - ยซ๐ ุชูุงุณ ุจุง ูุงยป, ยซ๐ ุฑุงูููุงยป
  - ยซ๐จโ๐ผ ูพูู ุงุฏููยป (ุดุฑุท ุงุฏูู)

- **[Inline Keyboard]** ุจุฑ ุงุณุงุณ `UserHandlers.main_menu()` ุฏุฑ `handlers/user/user_handlers_aggregator.py`:
  - ยซ๐ซ ุฏุฑุงูุช ุงุชฺููุชยป, ยซโญ ุงุชฺููุชโูุง ุจุฑุชุฑ ูุตูยป, ยซ๐ ูุณุช ุจุฑุชุฑูุง ูุตูยป, ยซ๐ก ุงุชฺููุชโูุง ูพุดููุงุฏยป, ยซ๐ฎ ุงุชฺููุช ฺฉุงุฑุจุฑุงูยป, ยซ๐ ุฌุณุชุฌู ุงุชฺููุชยป, ยซ๐ ุฑุงูููุงยป

- **[ูุดุฏุงุฑ ูุงุณุงุฒฺฏุงุฑ]**: ุฏุฑ `app/registry/user_registry.py` ุงูุชูุง ูุงูุ Regex ุงุณุชุซูุง ุดุงูู ยซโ๏ธ ุชูุธูุงุช ุจุงุฒยป ุงุณุช. ุชูุตู:
  - ุง ูููโุฌุง ยซโ๏ธ ุชูุธูุงุช ฺฉุงูุงูยป ุงุณุชุงูุฏุงุฑุฏ ุดูุฏ.
  - ุง ูุฑ ุฏู ุงูฺฏู ูพุดุชุจุงู ุดููุฏ ุชุง ุฑฺฏุฑุณูู ุฑุฎ ูุฏูุฏ.

---

## ููุฑุณุช ฺฉูุฏูุง MVP (ููุงููฺฏ ุจุง ฺฉุฏ)

- **[ูุณุชู]**
  - `app.name`
  - `welcome` (Compatible ุจุง Markdown)
  - `help.title`, `help.body`

- **[ุฒุจุงู]**
  - `lang.choose_bilingual`
  - `lang.fa`, `lang.en`
  - `lang.saved`

- **[ฺฏุช ุนุถูุช]** (HTML-safe)
  - `membership.title.first`, `membership.title.reminder`
  - `membership.body`, `membership.list.item`
  - `membership.cta.joined`, `membership.retry.network`

- **[ููู ู ุฏฺฉููโูุง]**
  - `menu.title`
  - `menu.buttons.get` โ ยซ๐ซ ุฏุฑุงูุช ุงุชฺููุชยป / "๐ซ Get Attachments"
  - `menu.buttons.season_top` โ ยซโญ ุจุฑุชุฑูุง ูุตูยป / "โญ Season Top"
  - `menu.buttons.season_list` โ ยซ๐ ูุณุช ุจุฑุชุฑูุงยป / "๐ Top List"
  - `menu.buttons.suggested` โ ยซ๐ก ุงุชฺููุชโูุง ูพุดููุงุฏยป / "๐ก Suggested Attachments"
  - `menu.buttons.ua` โ ยซ๐ฎ ุงุชฺููุช ฺฉุงุฑุจุฑุงูยป / "๐ฎ User Attachments"
  - `menu.buttons.search` โ ยซ๐ ุฌุณุชุฌู ุงุชฺููุชยป / "๐ Search Attachments"
  - `menu.buttons.help` โ ยซ๐ ุฑุงูููุงยป / "๐ Help"
  - `menu.buttons.notify` โ ยซ๐ ุชูุธูุงุช ุงุนูุงูโูุงยป / "๐ Notification Settings"
  - `menu.buttons.contact` โ ยซ๐ ุชูุงุณ ุจุง ูุงยป / "๐ Contact Us"
  - `menu.buttons.admin` โ ยซ๐จโ๐ผ ูพูู ุงุฏููยป / "๐จโ๐ผ Admin Panel"
  - `menu.buttons.game_settings` โ ยซโ๏ธ ุชูุธูุงุช ฺฉุงูุงูยป / "โ๏ธ Game Settings"
  - `menu.buttons.user_settings` โ ยซโ๏ธ ุชูุธูุงุช ุฑุจุงุชยป / "โ๏ธ Bot Settings" (ุฌุฏุฏ)
  - `menu.buttons.back` โ ยซ๐ ุจุงุฒฺฏุดุชยป / "๐ Back"

ููููู JSON ฺฉูุชุงู:
```json
{
  "app.name": "CODM Attachments Bot",
  "lang.choose_bilingual": "ูุทูุงู ุฒุจุงู ุฎูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ\nPlease choose your language",
  "lang.fa": "๐ฎ๐ท ูุงุฑุณ",
  "lang.en": "๐ฌ๐ง English",
  "lang.saved": "โ ุฒุจุงู ุดูุง ุจู {lang_name} ุชุบุฑ ฺฉุฑุฏ.",
  "membership.title.first": "๐ ุจู ุฑุจุงุช {app_name} ุฎูุด ุขูุฏุฏ!",
  "membership.body": "ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุฑุจุงุชุ ูุทูุงู ุฏุฑ ฺฉุงูุงูโูุง ุฒุฑ ุนุถู ุดูุฏ:",
  "membership.cta.joined": "โ ุนุถู ุดุฏู",
  "menu.title": "ููู ุงุตู",
  "menu.buttons.user_settings": "โ๏ธ ุชูุธูุงุช ุฑุจุงุช"
}
```

---

## ุชุฒุฑู i18n ุฏุฑ ฺฏุช ุนุถูุช (HTML-safe)

- **[ููุทู ุชุฒุฑู]** `managers/channel_manager.py` โ `require_channel_membership`
  - ูุจู ุงุฒ ูุฑ ุจุฑุฑุณ ุนุถูุช:
    - `db = context.bot_data['database']`
    - `ok = await ensure_language(update, context, db)`
    - ุงฺฏุฑ `ok` ุจุฑุงุจุฑ False โ `return` (ููุชุธุฑ ุงูุชุฎุงุจ ุฒุจุงู)

- **[ุชุบุฑ ุงูุถุงูุง]**
  - `create_membership_message(channels, is_first_time: bool, lang: str) -> str`
  - `create_join_keyboard(channels, lang: str) -> InlineKeyboardMarkup`

- **[ููุงุญุธุงุช]** ุงู ูพุงูโูุง ุจุง `parse_mode='HTML'` ุงุฑุณุงู ูโุดููุฏุ ุชุฑุฌููโูุง ุจุงุฏ HTML-safe ุจุงุดูุฏ.

---

## i18n ุจุฑุง ููู ุงุตู (Reply/Inline)

- **[Reply Keyboard]** `handlers/user/modules/navigation/main_menu.py`
  - `lang = get_user_lang(update, context, self.db) or DEFAULT_LANG`
  - ูุชู ุฎูุดโุขูุฏ: `t("welcome", lang, app_name=t("app.name", lang))` (Markdown-safe)
  - ุจุฑฺุณุจ ุฏฺฉููโูุง: `kb("menu.buttons.*", lang)`
  - ุงูุฒูุฏู ุฏฺฉูู ุฌุฏุฏ ยซโ๏ธ ุชูุธูุงุช ุฑุจุงุชยป ุฏุฑ ฺฉูุงุฑ ุณุงุฎุชุงุฑ ูุนู (ุจุฏูู ุญุฐู ยซโ๏ธ ุชูุธูุงุช ฺฉุงูุงูยป)

- **[Inline Keyboard]** `handlers/user/user_handlers_aggregator.py` โ `main_menu()`
  - ุจุฑฺุณุจโูุง ุงุฒ `kb(...)` ุฎูุงูุฏู ุดููุฏ.
  - ุณุงุฎุชุงุฑ ููู ุจุง ูุชู `MESSAGES["welcome"]` ููโุชุฑุงุฒ ุจูุงูุฏ (Markdown).

---

## ุชูุธูุงุช ุฒุจุงู ฺฉุงุฑุจุฑ

- **[ูุงฺูู ุฌุฏุฏ]** `handlers/user/modules/settings/language_handler.py`
  - `open_user_settings(update, context)` โ ููุงุด ยซโ๏ธ ุชูุธูุงุช ุฑุจุงุชยป
  - `open_language_menu(update, context)` โ ฺฏุฒููโูุง ูุงุฑุณ/ุงูฺฏูุณ
  - `set_language(update, context)` โ ุฐุฎุฑู ุฏุฑ DBุ ฺฉุด ุฏุฑ `context.user_data`, ูพุงู `lang.saved`ุ ุณูพุณ ูุฏุงุช ุจู ฺฏุช ุนุถูุช ุง ููู

- **[ุซุจุช ููุฏูุฑ]** `app/registry/user_registry.py`
  - Callback ุจุฑุง ยซUser Settingsยป ู ยซLanguageยป
  - Callback ุจุฑุง `^set_lang_(fa|en)$`

---

## ุณุงุฒฺฏุงุฑ ุจุง MessageHandlerูุง Regex

- **[ูุถุนุช]** ููุฏูุฑูุง Reply ููุท ูุงุฑุณ ูุณุชูุฏ.
- **[ุฑุงูฺฉุงุฑ ุณุฑุน]** ุซุจุช Regex ุงูฺฏูุณ ููุงุฒ ุจุฑุง ูุฑ ุฏฺฉูู ูุงุฑุณ:
  - ยซ๐ซ ุฏุฑุงูุช ุงุชฺููุชยป โ "๐ซ Get Attachments"
  - ยซ๐ ุฑุงูููุงยป โ "๐ Help"
  - ยซ๐ฎ ุงุชฺููุช ฺฉุงุฑุจุฑุงูยป โ "๐ฎ User Attachments"
  - ยซโญ ุจุฑุชุฑูุง ูุตูยป โ "โญ Season Top"
  - ยซ๐ ูุณุช ุจุฑุชุฑูุงยป โ "๐ Top List"
  - ยซ๐ ุฌุณุชุฌู ุงุชฺููุชยป โ "๐ Search Attachments"
  - ยซ๐ก ุงุชฺููุชโูุง ูพุดููุงุฏยป โ "๐ก Suggested Attachments"
  - ยซ๐ ุชูุธูุงุช ุงุนูุงูโูุงยป โ "๐ Notification Settings"
  - ยซ๐ ุชูุงุณ ุจุง ูุงยป โ "๐ Contact Us"
  - ยซ๐จโ๐ผ ูพูู ุงุฏููยป โ "๐จโ๐ผ Admin Panel"
  - ยซ๐ ุจุงุฒฺฏุดุชยป โ "๐ Back"
  - ยซโ๏ธ ุชูุธูุงุช ฺฉุงูุงูยป โ "โ๏ธ Game Settings"
  - ููฺูู ุงุณุชุซูุง Regex ยซโ๏ธ ุชูุธูุงุช ุจุงุฒยป ุฑุง ุง ุญุฐู/ฺฉุณุงูโุณุงุฒ ฺฉูุฏ ุง ูุนุงุฏู ุงูฺฏูุณโุงุด ุฑุง ุจุงูุฒุงุฏ.
- **[ุฑุงูฺฉุงุฑ ูพุงุฏุงุฑ]** ููุงุฌุฑุช ุชุฏุฑุฌ ุจู `InlineKeyboard` + `callback_data`ูุง ุซุงุจุช ูุณุชูู ุงุฒ ูุชู.

---

## ุชุบุฑุงุช ุฏุชุงุจุณ ู ุขุฏุงูพุชุฑ

- **[Migration]** `scripts/migrations/2025-11-02_add_user_language.sql`
```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS language TEXT;
UPDATE users SET language = 'fa' WHERE language IS NULL;
```
- **[Proxy/Adapter]**
  - `core/database/database_pg_proxy.py`:
    - `def get_user_language(self, user_id: int) -> Optional[str]`
    - `def set_user_language(self, user_id: int, lang: str) -> bool`
  - `core/database/database_adapter.py`:
    - ุงูุถุง ูุนุงุฏู ู pass-through ุจู Proxy

---

## ูพฺฉุฑุจูุฏ ู ENV (ุณุงุฒฺฏุงุฑ ุจุง MESSAGES)

- **[.env]**
  - `DEFAULT_LANG=fa`
  - `SUPPORTED_LANGS=fa,en`
  - `FALLBACK_LANG=en`
  - `LANGUAGE_ONBOARDING=true`

- **[config/config.py]**
  - ุฎูุงูุฏู ฺฉูุฏูุง ุจุงูุง ุจุง fallback ุงูู ุจู ุฑูุชุงุฑ ูุนู (fa) ุฏุฑ ุตูุฑุช ูุจูุฏ.
  - ุชูุตู: `.env.example` ุฑุง ุจูโุฑูุฒ ฺฉูุฏ.

---

## Parse Mode ู ุงูู ูุชูโูุง

- **[ุนุถูุช]** ูพุงูโูุง ุนุถูุช ุจุง `parse_mode='HTML'` ุงุฑุณุงู ูโุดููุฏ โ ุชุฑุฌููโูุง ุนุถูุช HTML-safe ุจุงุดูุฏ.
- **[ุฎูุดโุขูุฏ/ููู]** ุงุฒ `MESSAGES["welcome"]` ุจุง `parse_mode='Markdown'` ุงุณุชูุงุฏู ูโุดูุฏ โ ุชุฑุฌููโูุง Markdown-safe ุจุงุดูุฏ ุง ุฏุฑ ุตูุฑุช ูุงุฒ ฺฉูพุงุฑฺู ุจู HTML ููุงุฌุฑุช ุดูุฏ (ูุงุฒ ุจุนุฏ).

---

## ุฌุฑุงู ฺฉุงุฑุจุฑ (ุฏุงฺฏุฑุงู)

```mermaid
flowchart TD
A[/start] --> B{language set?}
B -- No --> C[send bilingual language picker]
C -->|user picks| D[save user.language]
D --> E{member of required channels?}
B -- Yes --> E
E -- No --> F[send localized membership message + join keyboard]
F --> G[User clicks Joined]
G --> E
E -- Yes --> H[show localized main menu]
```

---

## ุชุณุชโูุง

- **[Unit]**
  - `t()` ฺฉูุฏ ููุฌูุฏ/ูุงููุฌูุฏุ ูพุงุฑุงูุชุฑฺฏุฐุงุฑุ fallback ุจู `MESSAGES`.
  - `ensure_language()` ูุณุฑ ุฒุจุงู ูุงูุดุฎุต โ ุงุฑุณุงู ูพุงู ุงูุชุฎุงุจ ุฒุจุงู.
- **[Integration]**
  - `/start` ุจุฏูู ุฒุจุงู โ ุงูุชุฎุงุจ ุฒุจุงู โ ูพุงู ุนุถูุช HTML-safe ุจู ููุงู ุฒุจุงู.
  - `/start` ุจุง ุฒุจุงู โ ุงฺฏุฑ ุนุถู ูุณุช ูพุงู ุนุถูุชุ ุงฺฏุฑ ุนุถู ุงุณุช ููู ุงุตู ูุญูโุณุงุฒโุดุฏู.
  - ุชุบุฑ ุฒุจุงู ุงุฒ ยซโ๏ธ ุชูุธูุงุช ุฑุจุงุช โ ๐ฃ๏ธ ุฒุจุงูยป ู ุจุงุฒฺฏุดุช ุจู ููู.
- **[Regression]**
  - ููุฏูุฑูุง Reply/Inline ูุนู ุจุฏูู ุดฺฉุณุช.
- **[Parse Mode]**
  - ุงูู ุชุฑุฌููโูุง ุฏุฑ Markdown/HTML.

---

## ุงูุชุดุงุฑ ู ุจุงุฒฺฏุดุช

- **[Branch]** `feature/i18n-mvp`
- **[ูุฑุงุญู]**
  1) ุงูุฒูุฏู ฺฉุงุชุงููฺฏโูุง ู ูุงฺููโูุง `utils/i18n.py`, `utils/language.py` ุจุง fallback ุจู `MESSAGES`.
  2) Migration ุณุชูู ุฒุจุงู ู ูุชุฏูุง DB (Adapter/Proxy).
  3) ุชุฒุฑู `ensure_language` ุงุจุชุฏุง `require_channel_membership` + ุงูุถุง ุฌุฏุฏ ูพุงู/ฺฉุจูุฑุฏ ุนุถูุช ุจุง `lang`.
  4) ูุญูโุณุงุฒ ููู Reply/Inline + ุงูุฒูุฏู ุฏฺฉูู ยซโ๏ธ ุชูุธูุงุช ุฑุจุงุชยป.
  5) ุงูุฒูุฏู Regex ุงูฺฏูุณ ููุงุฒ + ฺฉุณุงูโุณุงุฒ ยซโ๏ธ ุชูุธูุงุช ฺฉุงูุงู/ุจุงุฒยป.
- **[Stage/Prod]**
  - Stage ุจุง `LANGUAGE_ONBOARDING=true`ุ ุณูุงุฑููุง ุจุญุฑุงู.
  - Prod ุชุฏุฑุฌุ ูพุงุด ูุงฺฏโูุง ู ูุชุฑฺฉ ุงูุชุฎุงุจ ุฒุจุงู.
- **[Rollback]**
  - `LANGUAGE_ONBOARDING=false` ุจุฏูู ุญุฐู ฺฉุฏ ุจุฑุง ุจุงุฒฺฏุดุช ุณุฑุน.

---

## ุฑุณฺฉโูุง ู ฺฉุงููุฏูโูุง

- **[Regex ุฏูโุฒุจุงูู]** ุชุถุงุฏ ุจุฑฺุณุจโูุง โ ูพุงุฑุช ุงูฺฏูุณ + ุจุฑูุงูู ููุงุฌุฑุช ุจู `callback_data`.
- **[ุชุฑุชุจ ุงุฌุฑุง]** `ensure_language` ุญุชูุงู ูุจู ุงุฒ ุนุถูุช.
- **[Cache]** `context.user_data["_lang"]` ุจุฑุง ฺฉุงูุด ุจุงุฑ DB.
- **[Markdown pitfalls]** ุจุฑุง ูุชูโูุง ุญุณุงุณุ HTML ุฑุง ุชุฑุฌุญ ุฏูุฏ.

---

## ฺฺฉโูุณุช ุงุฌุฑุง ูุฑุญููโุง (ุจูโุฑูุฒ)

- [ ] **[ฺฉุงุชุงููฺฏโูุง]** ุงุฌุงุฏ `locales/fa.json` ู `locales/en.json` ุจุง ฺฉูุฏูุง ุจุงูุง (ููุงููฺฏ ุจุง ุจุฑฺุณุจโูุง ูุนู).
- [ ] **[i18n module]** ูพุงุฏูโุณุงุฒ `utils/i18n.py` ุจุง fallback ุจู `MESSAGES`.
- [ ] **[language module]** ูพุงุฏูโุณุงุฒ `utils/language.py` (get_user_lang, ensure_language).
- [ ] **[DB migration]** ุงูุฒูุฏู ุณุชูู `users.language` ู backfill `fa`.
- [ ] **[DB methods]** `get_user_language` ู `set_user_language` ุฏุฑ Adapter/Proxy.
- [ ] **[membership gate]** ุชุฒุฑู `ensure_language` ุฏุฑ `require_channel_membership` ู ุงูุฒูุฏู ูพุงุฑุงูุชุฑ `lang` ุจู ูุชุฏูุง ูพุงู/ฺฉุจูุฑุฏ ุนุถูุช.
- [ ] **[main menu]** ูุญูโุณุงุฒ Reply/Inline ู ุงูุฒูุฏู ยซโ๏ธ ุชูุธูุงุช ุฑุจุงุชยป.
- [ ] **[regex parity]** ุงูุฒูุฏู Regex ุงูฺฏูุณ ููุงุฒ ู ุญู ยซโ๏ธ ุชูุธูุงุช ฺฉุงูุงู/ุจุงุฒยป.
- [ ] **[env/config]** ุงูุฒูุฏู ฺฉูุฏูุง ENV ู ุฎูุงูุฏู ุงูู ุฏุฑ `config/config.py`.
- [ ] **[tests]** ูุงุญุฏ/ฺฉูพุงุฑฺู ุจุง ุชูุฑฺฉุฒ ุจุฑ Parse Mode.
- [ ] **[stage rollout]** ูุนุงูโุณุงุฒ ุฑู Stage ู ูพุงุด.
- [ ] **[prod rollout]** ุงูุชุดุงุฑ ุชุฏุฑุฌ ุจุง ุงูฺฉุงู ุจุงุฒฺฏุดุช ุณุฑุน.

---

## ูุนุงุฑูุง ุชุญูู (DoD)

- **[ุงูุชุฎุงุจ ุฒุจุงู]** ูุจู ุงุฒ ฺฏุช ุนุถูุช ููุงุด ุฏุงุฏู ูโุดูุฏ.
- **[ูพูุณุชฺฏ ุฒุจุงู]** ููู ูพุงูโูุง ูุทุงุจู ุฒุจุงู ฺฉุงุฑุจุฑ.
- **[ุชูุธูุงุช]** ฺฉุงุฑุจุฑ ูโุชูุงูุฏ ุฒุจุงู ุฑุง ุชุบุฑ ุฏูุฏ.
- **[ุจุฏูู ุฑฺฏุฑุณูู]** ุฌุฑุงูโูุง Reply/Inline ุจุฏูู ุดฺฉุณุช.
- **[ูุงฺฏโูุง]** ุฑูุฏุงุฏูุง ุงูุชุฎุงุจ/ุชุบุฑ ุฒุจุงู ุซุจุช ูโุดููุฏ.
- **[ูพฺฉุฑูโุจูุฏโูพุฐุฑ]** ุจุง ENV ูุงุจู ฺฉูุชุฑู ุงุณุช.
